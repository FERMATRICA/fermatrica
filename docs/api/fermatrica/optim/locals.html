<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.3"/>
    <title>fermatrica.optim.locals API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../optim.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;fermatrica.optim</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="function" href="#optimize_local_cobyla">optimize_local_cobyla</a>
            </li>
            <li>
                    <a class="function" href="#optimize_local_bobyqa">optimize_local_bobyqa</a>
            </li>
            <li>
                    <a class="function" href="#optimize_local_sbplx">optimize_local_sbplx</a>
            </li>
            <li>
                    <a class="function" href="#optimize_local_rbf">optimize_local_rbf</a>
            </li>
            <li>
                    <a class="function" href="#optimize_local_ncma">optimize_local_ncma</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../fermatrica.html">fermatrica</a><wbr>.<a href="./../optim.html">optim</a><wbr>.locals    </h1>

                        <div class="docstring"><p>Wrappers for model outer layer optimization (local algos).</p>

<p>Both global and local algorithms are supported. As for now two derivative-free algos are included:</p>

<ol>
<li>COBYLA constrained optimization by linear approximations (local)</li>
<li>PyGad genetic algorithm (global)</li>
</ol>

<p>However, FERMATRICA architecture allows fast and simple adding new algorithms, and some
algos could be added later.</p>

<p>Derivative-free approach allows optimising without calculating (analytical) gradient what could be
very complex and time-consuming. However, some derivative algo (e.g. GS) could be added later
at least for some most popular transformations.</p>
</div>

                        <input id="mod-locals-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-locals-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="sd">Wrappers for model outer layer optimization (local algos).</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="sd">Both global and local algorithms are supported. As for now two derivative-free algos are included:</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="sd">1. COBYLA constrained optimization by linear approximations (local)</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="sd">2. PyGad genetic algorithm (global)</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="sd">However, FERMATRICA architecture allows fast and simple adding new algorithms, and some</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="sd">algos could be added later.</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="sd">Derivative-free approach allows optimising without calculating (analytical) gradient what could be</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="sd">very complex and time-consuming. However, some derivative algo (e.g. GS) could be added later</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="sd">at least for some most popular transformations.</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="kn">import</span> <span class="nn">copy</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="kn">import</span> <span class="nn">logging</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">cpu_count</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="kn">import</span> <span class="nn">nlopt</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="kn">import</span> <span class="nn">nevergrad</span> <span class="k">as</span> <span class="nn">ng</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="kn">from</span> <span class="nn">smt.surrogate_models</span> <span class="kn">import</span> <span class="n">RBF</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="kn">from</span> <span class="nn">fermatrica.model.model</span> <span class="kn">import</span> <span class="n">Model</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="kn">from</span> <span class="nn">fermatrica.optim.objective</span> <span class="kn">import</span> <span class="n">ObjectiveFunction</span><span class="p">,</span> <span class="n">ObjectiveRBF</span><span class="p">,</span> <span class="n">ObjectiveNG</span><span class="p">,</span> <span class="n">VerboseNG</span><span class="p">,</span> <span class="n">_save_model</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="k">def</span> <span class="nf">optimize_local_cobyla</span><span class="p">(</span><span class="n">ds</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>                          <span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="s2">&quot;Model&quot;</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>                          <span class="p">,</span> <span class="n">revert_score_sign</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>                          <span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>                          <span class="p">,</span> <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>                          <span class="p">,</span> <span class="n">iters_epoch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>                          <span class="p">,</span> <span class="n">error_score</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e+12</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>                          <span class="p">,</span> <span class="n">ftol_abs</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">.01</span><span class="p">):</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">    Wrapper for COBYLA constrained optimization by local approximations algorithm (local). COBYLA</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">    is derivative-free, so no analytical gradient is required.</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">    COBYLA minimizes score, so be careful to revert score if it is designed as maximizer before use</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">    or with argument `revert_score_sign=True`.</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">    Epochs are required to shuffle params a bit and to help algo get out from local optimum (sometimes)</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">    and to speed up calculation.</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">    Early stop threshold is defined as minimum absolute score gain per iteration. However, algo doesn&#39;t</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">    respect it directly, so don&#39;t be upset to see it working with much lesser gain per iteration.</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">    Local algorithms could be sensitive to starting (initial) values and to the number of optimising</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">    params. If params number is big enough (say, dozens) it is better to use it chunks, tuning</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">    one portion of params after another. Params for every chunk should be chosen wisely and not</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="sd">    just first 10 or 20 params, them second 10 or 20 etc.</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">    Nlopt COBYLA implementation is preferred before `scipy.optimize.minimize(method=&#39;COBYLA&#39;)` because</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="sd">    latter doesn&#39;t respect constraints accurately.</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">    However, Nlopt COBYLA has its own annoying issue. If improvement is (much?) below machine precision,</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">    it stops with error. We have some thoughts about workarounds to be implemented later, but as for now</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="sd">    be aware starting values are not to close to the borders, e.g. 0.9999999999999 when border is 1.0.</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="sd">    Move starting value a little further, e.g. to .95, and in most times it will be enough.</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">    :param ds: dataset</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="sd">    :param model: Model object</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="sd">    :param revert_score_sign: if the score is the bigger, the better; this algo minimizes score</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="sd">    :param verbose: print diagnostic or progress information</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a><span class="sd">    :param epochs: number of epochs</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a><span class="sd">    :param iters_epoch: number of objective function calculations per epoch</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="sd">    :param error_score: extremely big value to be used as score if fit_predict returns None (error)</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a><span class="sd">    :param ftol_abs: early stop threshold: minimum absolute score gain per iteration, see description</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a><span class="sd">    :return: tuned Model</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>    <span class="n">params_subset</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>    <span class="k">if</span> <span class="n">params_subset</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No active non-fixed parameters to optimize&quot;</span><span class="p">)</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>        <span class="k">return</span> <span class="n">model</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>        <span class="n">if_error</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>        <span class="c1"># rebuild objective function every epoch to update model.conf</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>        <span class="n">objective_fun</span> <span class="o">=</span> <span class="n">ObjectiveFunction</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">ds</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>                                          <span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>                                          <span class="p">,</span> <span class="n">revert_score_sign</span><span class="o">=</span><span class="n">revert_score_sign</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>                                          <span class="p">,</span> <span class="n">error_score</span><span class="o">=</span><span class="n">error_score</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>                                          <span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>        <span class="n">start_values</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>        <span class="n">opt_obj</span> <span class="o">=</span> <span class="n">nlopt</span><span class="o">.</span><span class="n">opt</span><span class="p">(</span><span class="n">nlopt</span><span class="o">.</span><span class="n">LN_COBYLA</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_values</span><span class="p">))</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_min_objective</span><span class="p">(</span><span class="n">objective_fun</span><span class="p">)</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_lower_bounds</span><span class="p">(</span><span class="n">params_subset</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_upper_bounds</span><span class="p">(</span><span class="n">params_subset</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_ftol_abs</span><span class="p">(</span><span class="n">ftol_abs</span><span class="p">)</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_maxeval</span><span class="p">(</span><span class="n">iters_epoch</span><span class="p">)</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_maxtime</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>            <span class="n">rtrn</span> <span class="o">=</span> <span class="n">opt_obj</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">start_values</span><span class="p">)</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>        <span class="k">except</span> <span class="p">(</span><span class="n">nlopt</span><span class="o">.</span><span class="n">RoundoffLimited</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>            <span class="n">rtrn</span> <span class="o">=</span> <span class="n">start_values</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>            <span class="n">if_error</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Epoche terminated unsuccessfully due to ROUNDOFF error&quot;</span><span class="p">)</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Epoche &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; finished&#39;</span><span class="p">)</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rtrn</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rtrn</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtrn</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Epoche did not terminate successfully&quot;</span><span class="p">)</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>        <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span>\
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]][</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>        <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span>\
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]][</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>        <span class="k">if</span> <span class="n">if_error</span><span class="p">:</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>            <span class="k">break</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>    <span class="k">return</span> <span class="n">model</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a><span class="k">def</span> <span class="nf">optimize_local_bobyqa</span><span class="p">(</span><span class="n">ds</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>                          <span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="s2">&quot;Model&quot;</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>                          <span class="p">,</span> <span class="n">revert_score_sign</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>                          <span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>                          <span class="p">,</span> <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>                          <span class="p">,</span> <span class="n">iters_epoch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>                          <span class="p">,</span> <span class="n">error_score</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e+12</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>                          <span class="p">,</span> <span class="n">ftol_abs</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">.01</span><span class="p">):</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a><span class="sd">    Wrapper for BOBYQA constrained optimization by local approximations algorithm (local). BOBYQA</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a><span class="sd">    is derivative-free, so no analytical gradient is required.</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a><span class="sd">    BOBYQA minimizes score, so be careful to revert score if it is designed as maximizer before use</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a><span class="sd">    or with argument `revert_score_sign=True`.</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="sd">    Epochs are required to shuffle params a bit and to help algo get out from local optimum (sometimes)</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a><span class="sd">    and to speed up calculation.</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a><span class="sd">    Early stop threshold is defined as minimum absolute score gain per iteration. However, algo doesn&#39;t</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a><span class="sd">    respect it directly, so don&#39;t be upset to see it working with much lesser gain per iteration.</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a><span class="sd">    Local algorithms could be sensitive to starting (initial) values and to the number of optimising</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a><span class="sd">    params. If params number is big enough (say, dozens) it is better to use it chunks, tuning</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a><span class="sd">    one portion of params after another. Params for every chunk should be chosen wisely and not</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a><span class="sd">    just first 10 or 20 params, them second 10 or 20 etc.</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a><span class="sd">    Nlopt BOBYQA implementation is preferred before `scipy.optimize.minimize(method=&#39;BOBYQA&#39;)` because</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a><span class="sd">    latter doesn&#39;t respect constraints accurately.</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a><span class="sd">    However, Nlopt BOBYQA has its own annoying issue. If improvement is (much?) below machine precision,</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a><span class="sd">    it stops with error. We have some thoughts about workarounds to be implemented later, but as for now</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a><span class="sd">    be aware starting values are not to close to the borders, e.g. 0.9999999999999 when border is 1.0.</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a><span class="sd">    Move starting value a little further, e.g. to .95, and in most times it will be enough.</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a><span class="sd">    :param ds: dataset</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a><span class="sd">    :param model: Model object</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a><span class="sd">    :param revert_score_sign: if the score is the bigger, the better; this algo minimizes score</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a><span class="sd">    :param verbose: print diagnostic or progress information</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a><span class="sd">    :param epochs: number of epochs</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a><span class="sd">    :param iters_epoch: number of objective function calculations per epoch</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a><span class="sd">    :param error_score: extremely big value to be used as score if fit_predict returns None (error)</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a><span class="sd">    :param ftol_abs: early stop threshold: minimum absolute score gain per iteration, see description</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a><span class="sd">    :return: tuned Model</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>    <span class="n">params_subset</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>    <span class="k">if</span> <span class="n">params_subset</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No active non-fixed parameters to optimize&quot;</span><span class="p">)</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>        <span class="k">return</span> <span class="n">model</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>        <span class="n">if_error</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>        <span class="c1"># rebuild objective function every epoch to update model.conf</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>        <span class="n">objective_fun</span> <span class="o">=</span> <span class="n">ObjectiveFunction</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">ds</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>                                          <span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>                                          <span class="p">,</span> <span class="n">revert_score_sign</span><span class="o">=</span><span class="n">revert_score_sign</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>                                          <span class="p">,</span> <span class="n">error_score</span><span class="o">=</span><span class="n">error_score</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>                                          <span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>        <span class="n">start_values</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>        <span class="n">opt_obj</span> <span class="o">=</span> <span class="n">nlopt</span><span class="o">.</span><span class="n">opt</span><span class="p">(</span><span class="n">nlopt</span><span class="o">.</span><span class="n">LN_BOBYQA</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_values</span><span class="p">))</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_min_objective</span><span class="p">(</span><span class="n">objective_fun</span><span class="p">)</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_lower_bounds</span><span class="p">(</span><span class="n">params_subset</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_upper_bounds</span><span class="p">(</span><span class="n">params_subset</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_ftol_abs</span><span class="p">(</span><span class="n">ftol_abs</span><span class="p">)</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_maxeval</span><span class="p">(</span><span class="n">iters_epoch</span><span class="p">)</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_maxtime</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>            <span class="n">rtrn</span> <span class="o">=</span> <span class="n">opt_obj</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">start_values</span><span class="p">)</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>        <span class="k">except</span> <span class="p">(</span><span class="n">nlopt</span><span class="o">.</span><span class="n">RoundoffLimited</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>            <span class="n">rtrn</span> <span class="o">=</span> <span class="n">start_values</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>            <span class="n">if_error</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Epoche terminated unsuccessfully due to ROUNDOFF error&quot;</span><span class="p">)</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Epoche &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; finished&#39;</span><span class="p">)</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rtrn</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rtrn</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtrn</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Epoche did not terminate successfully&quot;</span><span class="p">)</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>        <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span>\
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]][</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>        <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span>\
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]][</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>        <span class="k">if</span> <span class="n">if_error</span><span class="p">:</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>            <span class="k">break</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>    <span class="k">return</span> <span class="n">model</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a><span class="k">def</span> <span class="nf">optimize_local_sbplx</span><span class="p">(</span><span class="n">ds</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>                         <span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="s2">&quot;Model&quot;</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>                         <span class="p">,</span> <span class="n">revert_score_sign</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>                         <span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>                         <span class="p">,</span> <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>                         <span class="p">,</span> <span class="n">iters_epoch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>                         <span class="p">,</span> <span class="n">error_score</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e+12</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>                         <span class="p">,</span> <span class="n">ftol_abs</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">.01</span><span class="p">):</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a><span class="sd">    Wrapper for Sblpx / Subplex constrained optimization by local approximations algorithm (local). Sblpx / Subplex</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a><span class="sd">    is derivative-free, so no analytical gradient is required.</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a><span class="sd">    Sblpx / Subplex minimizes score, so be careful to revert score if it is designed as maximizer before use</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a><span class="sd">    or with argument `revert_score_sign=True`.</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a><span class="sd">    Epochs are required to shuffle params a bit and to help algo get out from local optimum (sometimes)</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a><span class="sd">    and to speed up calculation.</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a><span class="sd">    Early stop threshold is defined as minimum absolute score gain per iteration. However, algo doesn&#39;t</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a><span class="sd">    respect it directly, so don&#39;t be upset to see it working with much lesser gain per iteration.</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a><span class="sd">    Local algorithms could be sensitive to starting (initial) values and to the number of optimising</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a><span class="sd">    params. If params number is big enough (say, dozens) it is better to use it chunks, tuning</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a><span class="sd">    one portion of params after another. Params for every chunk should be chosen wisely and not</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a><span class="sd">    just first 10 or 20 params, them second 10 or 20 etc.</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a><span class="sd">    Nlopt Sblpx / Subplex implementation is preferred before `scipy.optimize.minimize(method=&#39;Sblpx / Subplex&#39;)` because</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a><span class="sd">    latter doesn&#39;t respect constraints accurately.</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a><span class="sd">    However, Nlopt Sblpx / Subplex has its own annoying issue. If improvement is (much?) below machine precision,</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a><span class="sd">    it stops with error. We have some thoughts about workarounds to be implemented later, but as for now</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a><span class="sd">    be aware starting values are not to close to the borders, e.g. 0.9999999999999 when border is 1.0.</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a><span class="sd">    Move starting value a little further, e.g. to .95, and in most times it will be enough.</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a><span class="sd">    :param ds: dataset</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a><span class="sd">    :param model: Model object</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a><span class="sd">    :param revert_score_sign: if the score is the bigger, the better; this algo minimizes score</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a><span class="sd">    :param verbose: print diagnostic or progress information</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a><span class="sd">    :param epochs: number of epochs</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a><span class="sd">    :param iters_epoch: number of objective function calculations per epoch</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a><span class="sd">    :param error_score: extremely big value to be used as score if fit_predict returns None (error)</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a><span class="sd">    :param ftol_abs: early stop threshold: minimum absolute score gain per iteration, see description</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a><span class="sd">    :return: tuned Model</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>    <span class="n">params_subset</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>    <span class="k">if</span> <span class="n">params_subset</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No active non-fixed parameters to optimize&quot;</span><span class="p">)</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>        <span class="k">return</span> <span class="n">model</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>        <span class="n">if_error</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>        <span class="c1"># rebuild objective function every epoch to update model.conf</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>        <span class="n">objective_fun</span> <span class="o">=</span> <span class="n">ObjectiveFunction</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">ds</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>                                          <span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>                                          <span class="p">,</span> <span class="n">revert_score_sign</span><span class="o">=</span><span class="n">revert_score_sign</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>                                          <span class="p">,</span> <span class="n">error_score</span><span class="o">=</span><span class="n">error_score</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>                                          <span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>        <span class="n">start_values</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>        <span class="n">opt_obj</span> <span class="o">=</span> <span class="n">nlopt</span><span class="o">.</span><span class="n">opt</span><span class="p">(</span><span class="n">nlopt</span><span class="o">.</span><span class="n">LN_SBPLX</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_values</span><span class="p">))</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_min_objective</span><span class="p">(</span><span class="n">objective_fun</span><span class="p">)</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_lower_bounds</span><span class="p">(</span><span class="n">params_subset</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_upper_bounds</span><span class="p">(</span><span class="n">params_subset</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_ftol_abs</span><span class="p">(</span><span class="n">ftol_abs</span><span class="p">)</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_maxeval</span><span class="p">(</span><span class="n">iters_epoch</span><span class="p">)</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_maxtime</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>            <span class="n">rtrn</span> <span class="o">=</span> <span class="n">opt_obj</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">start_values</span><span class="p">)</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>        <span class="k">except</span> <span class="p">(</span><span class="n">nlopt</span><span class="o">.</span><span class="n">RoundoffLimited</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>            <span class="n">rtrn</span> <span class="o">=</span> <span class="n">start_values</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>            <span class="n">if_error</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Epoche terminated unsuccessfully due to ROUNDOFF error&quot;</span><span class="p">)</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Epoche &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; finished&#39;</span><span class="p">)</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rtrn</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rtrn</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtrn</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Epoche did not terminate successfully&quot;</span><span class="p">)</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>        <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span>\
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]][</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>        <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span>\
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]][</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>        <span class="k">if</span> <span class="n">if_error</span><span class="p">:</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>            <span class="k">break</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>    <span class="k">return</span> <span class="n">model</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a><span class="k">def</span> <span class="nf">optimize_local_rbf</span><span class="p">(</span><span class="n">ds</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>                       <span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="s2">&quot;Model&quot;</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>                       <span class="p">,</span> <span class="n">revert_score_sign</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>                       <span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>                       <span class="p">,</span> <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>                       <span class="p">,</span> <span class="n">iters_epoch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>                       <span class="p">,</span> <span class="n">error_score</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e+12</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>                       <span class="p">,</span> <span class="n">cores</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>                       <span class="p">,</span> <span class="n">ftol_abs</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">.01</span><span class="p">):</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a><span class="sd">    Surrogate-model-based optimization with parallel evaluation.</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a><span class="sd">    Bayesian optimization using RBF surrogate model and Latin Hypercube Sampling.</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a><span class="sd">    :param ds: dataset</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a><span class="sd">    :param model: Model object</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a><span class="sd">    :param revert_score_sign: if the score is the bigger, the better; this algo minimizes score</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a><span class="sd">    :param verbose: print diagnostic or progress information</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a><span class="sd">    :param epochs: number of epochs</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a><span class="sd">    :param iters_epoch: number of objective function calculations per epoch</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a><span class="sd">    :param error_score: extremely big value to be used as score if fit_predict returns None (error)</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a><span class="sd">    :param cores: processor cores to be used in parallel computing</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a><span class="sd">    :param ftol_abs: early stop threshold: minimum absolute score gain per iteration, see description</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a><span class="sd">    :return: tuned Model</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>    <span class="n">params_subset</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>    <span class="n">start_values</span> <span class="o">=</span> <span class="n">params_subset</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>    <span class="k">if</span> <span class="n">params_subset</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No active non-fixed parameters to optimize&quot;</span><span class="p">)</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>        <span class="k">return</span> <span class="n">model</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>    <span class="k">if</span> <span class="n">cores</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>        <span class="n">cores</span> <span class="o">=</span> <span class="p">(</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Cores number for parallel computing is set too high for this computer. &#39;</span> <span class="o">+</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>                        <span class="s1">&#39;Reset to &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cores</span><span class="p">))</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>    <span class="c1"># extract bounds and parameter names</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>    <span class="n">n_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params_subset</span><span class="p">)</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>    <span class="n">param_names</span> <span class="o">=</span> <span class="n">params_subset</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>    <span class="n">lb</span> <span class="o">=</span> <span class="n">params_subset</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>    <span class="n">ub</span> <span class="o">=</span> <span class="n">params_subset</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>    <span class="c1"># generate initial points around model&#39;s current parameters</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>    <span class="k">def</span> <span class="nf">generate_initial_points</span><span class="p">(</span><span class="n">n_points</span><span class="p">):</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>        <span class="n">std_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">ub</span> <span class="o">-</span> <span class="n">lb</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.05</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">start_values</span><span class="p">,</span> <span class="p">(</span><span class="n">n_points</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>        <span class="n">points</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">std_dev</span><span class="p">,</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">)</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>        <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_values</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>        <span class="k">return</span> <span class="n">points</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>    <span class="c1"># objective function wrapper</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>    <span class="n">model_iter</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>    <span class="n">model_iter</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">transform_lhs_fn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>    <span class="n">objective_fun</span> <span class="o">=</span> <span class="n">ObjectiveFunction</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">ds</span><span class="p">,</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>                                      <span class="n">model</span><span class="o">=</span><span class="n">model_iter</span><span class="p">,</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>                                      <span class="n">revert_score_sign</span><span class="o">=</span><span class="n">revert_score_sign</span><span class="p">,</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>                                      <span class="n">error_score</span><span class="o">=</span><span class="n">error_score</span><span class="p">,</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>                                      <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>    <span class="c1"># parallel evaluation function</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>    <span class="k">def</span> <span class="nf">evaluate_points</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>        <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">objective_fun</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>    <span class="c1"># initialize surrogate model</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>    <span class="n">n_start</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n_params</span><span class="p">,</span> <span class="n">iters_epoch</span><span class="p">)</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>    <span class="n">param_train</span> <span class="o">=</span> <span class="n">generate_initial_points</span><span class="p">(</span><span class="n">n_start</span><span class="p">)</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>    <span class="n">score_train</span> <span class="o">=</span> <span class="n">evaluate_points</span><span class="p">(</span><span class="n">param_train</span><span class="p">)</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>    <span class="n">sm</span> <span class="o">=</span> <span class="n">RBF</span><span class="p">(</span><span class="n">d0</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n_params</span>   <span class="c1"># d0 controls basis function width</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>             <span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="mf">1e-6</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>             <span class="p">,</span> <span class="n">print_global</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>             <span class="p">,</span> <span class="n">print_training</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>             <span class="p">,</span> <span class="n">print_prediction</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>    <span class="n">sm</span><span class="o">.</span><span class="n">set_training_values</span><span class="p">(</span><span class="n">param_train</span><span class="p">,</span> <span class="n">score_train</span><span class="p">)</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>    <span class="n">sm</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>    <span class="c1"># main loop over epochs</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>        <span class="n">if_error</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>            <span class="c1"># batch acquisition via multi-start optimization</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>            <span class="n">batch_points</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>            <span class="n">optimize_surrogate</span> <span class="o">=</span> <span class="n">ObjectiveRBF</span><span class="p">(</span><span class="n">param_train</span><span class="o">=</span><span class="n">param_train</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>                                              <span class="p">,</span> <span class="n">score_train</span><span class="o">=</span><span class="n">score_train</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>                                              <span class="p">,</span> <span class="n">ub</span><span class="o">=</span><span class="n">ub</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>                                              <span class="p">,</span> <span class="n">lb</span><span class="o">=</span><span class="n">lb</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>                                              <span class="p">,</span> <span class="n">iters_epoch</span><span class="o">=</span><span class="n">iters_epoch</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>                                              <span class="p">,</span> <span class="n">ftol_abs</span><span class="o">=</span><span class="n">ftol_abs</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>                                              <span class="p">,</span> <span class="n">sm_object</span><span class="o">=</span><span class="n">sm</span><span class="p">)</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>            <span class="c1"># parallel batch point generation</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>            <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">cores</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>                <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">optimize_surrogate</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cores</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)]</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>                <span class="n">batch_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">]</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>            <span class="c1"># evaluate batch in parallel</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>            <span class="n">new_score</span> <span class="o">=</span> <span class="n">evaluate_points</span><span class="p">(</span><span class="n">batch_points</span><span class="p">)</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>            <span class="c1"># update training data</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>            <span class="n">param_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">param_train</span><span class="p">,</span> <span class="n">batch_points</span><span class="p">])</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>            <span class="n">score_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">score_train</span><span class="p">,</span> <span class="n">new_score</span><span class="p">])</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>            <span class="n">sm</span><span class="o">.</span><span class="n">set_training_values</span><span class="p">(</span><span class="n">param_train</span><span class="p">,</span> <span class="n">score_train</span><span class="p">)</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>            <span class="n">sm</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>            <span class="c1"># update model with best parameters</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>            <span class="n">best_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">score_train</span><span class="p">)</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>            <span class="n">best_params</span> <span class="o">=</span> <span class="n">param_train</span><span class="p">[</span><span class="n">best_idx</span><span class="p">]</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>            <span class="n">best_score</span> <span class="o">=</span> <span class="n">score_train</span><span class="p">[</span><span class="n">best_idx</span><span class="p">]</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>            <span class="n">model_iter</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">param_names</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_params</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>            <span class="c1"># logging</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>                <span class="n">score_print</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">best_score</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>                               <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">best_score</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">500</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>                               <span class="k">else</span> <span class="nb">round</span><span class="p">(</span><span class="n">best_score</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>                <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">timespec</span><span class="o">=</span><span class="s2">&quot;seconds&quot;</span><span class="p">)</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Combined scoring : &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">score_print</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;; epoch : &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>                    <span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; : &#39;</span> <span class="o">+</span> <span class="n">timestamp</span><span class="p">)</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoche terminated unsuccessfully&quot;</span><span class="p">)</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>            <span class="n">if_error</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>        <span class="c1"># boundary enforcement</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>        <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span>\
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]][</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>        <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span>\
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]][</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>        <span class="k">if</span> <span class="n">if_error</span><span class="p">:</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>            <span class="k">break</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>    <span class="k">return</span> <span class="n">model_iter</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a><span class="k">def</span> <span class="nf">optimize_local_ncma</span><span class="p">(</span><span class="n">ds</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>                        <span class="n">model</span><span class="p">:</span> <span class="s2">&quot;Model&quot;</span><span class="p">,</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>                        <span class="n">revert_score_sign</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>                        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>                        <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>                        <span class="n">iters_epoch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>                        <span class="n">error_score</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e+12</span><span class="p">,</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>                        <span class="n">cores</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>                        <span class="n">approach</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;init_sequent&#39;</span><span class="p">,</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>                        <span class="n">save_epoch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a><span class="sd">    Wrapper for CMA-ES optimization algorithm using nevergrad library. CMA-ES is a derivative-free</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a><span class="sd">    global optimizer that maintains search history between iterations. It can handle bounds</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a><span class="sd">    and is robust to noisy objective functions.</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a><span class="sd">    Early stop threshold is implemented via callback mechanism.</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a><span class="sd">    :param ds: dataset</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a><span class="sd">    :param model: Model object</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a><span class="sd">    :param revert_score_sign: if the score is the bigger, the better; this algo minimizes score</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a><span class="sd">    :param verbose: print diagnostic or progress information</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a><span class="sd">    :param epochs: number of epochs; each epoch is independent and returns its own score and tuned params</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a><span class="sd">    :param iters_epoch: number of iterations per epoch</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a><span class="sd">    :param error_score: extremely bad value to be used as score if fit_predict returns None (error)</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a><span class="sd">    :param cores: processor cores to be used in parallel computing</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a><span class="sd">    :param approach: &#39;void&#39;, &#39;init&#39;, &#39;sequent&#39;, &#39;init_sequent&#39;</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a><span class="sd">    :param save_epoch: if every epoch to be saved or path to the folder to save tuned models</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a><span class="sd">    :return: tuned Model of the last epoch</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>    <span class="n">params_subset</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>    <span class="k">if</span> <span class="n">params_subset</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No active non-fixed parameters to optimize&quot;</span><span class="p">)</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>        <span class="k">return</span> <span class="n">model</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>    <span class="c1"># set up multiprocessing</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>    <span class="k">if</span> <span class="n">cores</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>        <span class="n">cores</span> <span class="o">=</span> <span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Cores number for parallel computing is set too high for this computer. &#39;</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>                        <span class="sa">f</span><span class="s1">&#39;Reset to </span><span class="si">{</span><span class="n">cores</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>    <span class="c1"># get parameter bounds</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>    <span class="n">lwr</span> <span class="o">=</span> <span class="n">params_subset</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>    <span class="n">upr</span> <span class="o">=</span> <span class="n">params_subset</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>    <span class="n">lwr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">lwr</span><span class="p">,</span> <span class="n">nan</span><span class="o">=-</span><span class="mf">1e+8</span><span class="p">)</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>    <span class="n">upr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">upr</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">1e+8</span><span class="p">)</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>    <span class="c1"># create new objective function instance for each epoch</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>    <span class="n">model_iter</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>    <span class="n">model_iter</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">transform_lhs_fn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>    <span class="n">objective_fun</span> <span class="o">=</span> <span class="n">ObjectiveFunction</span><span class="p">(</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>        <span class="n">ds</span><span class="o">=</span><span class="n">ds</span><span class="p">,</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>        <span class="n">model</span><span class="o">=</span><span class="n">model_iter</span><span class="p">,</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>        <span class="n">revert_score_sign</span><span class="o">=</span><span class="n">revert_score_sign</span><span class="p">,</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>        <span class="n">error_score</span><span class="o">=</span><span class="n">error_score</span><span class="p">,</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>    <span class="p">)</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>    <span class="c1"># get start values</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>    <span class="n">start_values</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">params_subset</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>    <span class="n">param_names</span> <span class="o">=</span> <span class="n">params_subset</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>    <span class="n">best_score</span> <span class="o">=</span> <span class="n">objective_fun</span><span class="p">(</span><span class="n">params_cur</span><span class="o">=</span><span class="n">start_values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>    <span class="c1"># main epoch loop</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>    <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">cores</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>            <span class="c1"># set up search space</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>            <span class="k">if</span> <span class="n">approach</span> <span class="o">==</span> <span class="s1">&#39;void&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">approach</span> <span class="o">==</span> <span class="s1">&#39;sequent&#39;</span> <span class="ow">and</span> <span class="n">epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>                <span class="n">start_values_cur</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">bound</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bound</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">bound</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lwr</span><span class="p">,</span> <span class="n">upr</span><span class="p">)]</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>                <span class="n">start_values_cur</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">start_values</span><span class="p">)</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>            <span class="n">search_space</span> <span class="o">=</span> <span class="n">ng</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">Instrumentation</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>                <span class="n">name</span><span class="p">:</span> <span class="n">ng</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">Scalar</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">high</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">val</span><span class="p">)</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="n">lwr</span><span class="p">,</span> <span class="n">upr</span><span class="p">,</span> <span class="n">start_values_cur</span><span class="p">)</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>            <span class="p">})</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>            <span class="n">objective_ng</span> <span class="o">=</span> <span class="n">ObjectiveNG</span><span class="p">(</span><span class="n">param_names</span><span class="o">=</span><span class="n">param_names</span><span class="p">,</span> <span class="n">objective_fun</span><span class="o">=</span><span class="n">objective_fun</span><span class="p">)</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>            <span class="c1"># initialize CMA-ES</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">ng</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">CMA</span><span class="p">(</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>                <span class="n">parametrization</span><span class="o">=</span><span class="n">search_space</span><span class="p">,</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>                <span class="n">budget</span><span class="o">=</span><span class="n">iters_epoch</span><span class="p">,</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>                <span class="n">num_workers</span><span class="o">=</span><span class="n">cores</span><span class="p">,</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>            <span class="p">)</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>            <span class="c1"># callbacks</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>                <span class="n">verbose_cb</span> <span class="o">=</span> <span class="n">VerboseNG</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>                <span class="n">optimizer</span><span class="o">.</span><span class="n">register_callback</span><span class="p">(</span><span class="s1">&#39;tell&#39;</span><span class="p">,</span> <span class="n">verbose_cb</span><span class="p">)</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>            <span class="c1"># run optimization</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>                <span class="n">rtrn</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">objective_ng</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>                                          <span class="p">,</span> <span class="n">executor</span><span class="o">=</span><span class="n">executor</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>                                          <span class="c1"># , batch_mode=True</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>                                          <span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>                <span class="n">best_params</span> <span class="o">=</span> <span class="n">rtrn</span><span class="o">.</span><span class="n">value</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Epoche did not terminate successfully&quot;</span><span class="p">)</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>                <span class="n">best_params</span> <span class="o">=</span> <span class="n">start_values</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Epoche &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; finished&#39;</span><span class="p">)</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>            <span class="c1"># update model with the best parameters</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">best_params</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>                <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>                <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">:</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>                    <span class="n">param_value</span> <span class="o">=</span> <span class="n">best_params</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">par</span><span class="p">]</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>                    <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param_value</span><span class="p">)</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>                <span class="n">score_cur</span> <span class="o">=</span> <span class="n">objective_fun</span><span class="p">(</span><span class="n">params_cur</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>                <span class="k">if</span> <span class="n">approach</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;init_sequent&#39;</span><span class="p">,</span> <span class="s1">&#39;sequent&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">score_cur</span> <span class="o">&lt;</span> <span class="n">best_score</span><span class="p">:</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>                    <span class="n">start_values</span> <span class="o">=</span> <span class="n">params</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>                    <span class="n">best_score</span> <span class="o">=</span> <span class="n">score_cur</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>                <span class="k">elif</span> <span class="n">approach</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;init_sequent&#39;</span><span class="p">,</span> <span class="s1">&#39;sequent&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">score_cur</span> <span class="o">&gt;=</span> <span class="n">best_score</span><span class="p">:</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>                    <span class="n">params</span> <span class="o">=</span> <span class="n">start_values</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>                <span class="n">model_iter</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">params_subset</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Epoche did not terminate successfully&quot;</span><span class="p">)</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>            <span class="c1"># clip parameters to bounds</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>            <span class="n">optim_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">model_iter</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model_iter</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>            <span class="n">upper_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">model_iter</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">model_iter</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">optim_mask</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>            <span class="n">model_iter</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">upper_mask</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_iter</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">upper_mask</span><span class="p">,</span> <span class="s1">&#39;upper&#39;</span><span class="p">]</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>            <span class="n">lower_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">model_iter</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">model_iter</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">optim_mask</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>            <span class="n">model_iter</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lower_mask</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_iter</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lower_mask</span><span class="p">,</span> <span class="s1">&#39;lower&#39;</span><span class="p">]</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>            <span class="c1"># save model if required</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>            <span class="k">if</span> <span class="n">save_epoch</span><span class="p">:</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>                <span class="n">_save_model</span><span class="p">(</span><span class="n">model_iter</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">save_epoch</span><span class="p">)</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>    <span class="k">return</span> <span class="n">model_iter</span>
</span></pre></div>


            </section>
                <section id="optimize_local_cobyla">
                            <input id="optimize_local_cobyla-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">optimize_local_cobyla</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">ds</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>,</span><span class="param">	<span class="n">model</span><span class="p">:</span> <span class="n"><a href="../model/model.html#Model">fermatrica.model.model.Model</a></span>,</span><span class="param">	<span class="n">revert_score_sign</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>,</span><span class="param">	<span class="n">iters_epoch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span>,</span><span class="param">	<span class="n">error_score</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1000000000000.0</span>,</span><span class="param">	<span class="n">ftol_abs</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="optimize_local_cobyla-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#optimize_local_cobyla"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="optimize_local_cobyla-33"><a href="#optimize_local_cobyla-33"><span class="linenos"> 33</span></a><span class="k">def</span> <span class="nf">optimize_local_cobyla</span><span class="p">(</span><span class="n">ds</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
</span><span id="optimize_local_cobyla-34"><a href="#optimize_local_cobyla-34"><span class="linenos"> 34</span></a>                          <span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="s2">&quot;Model&quot;</span>
</span><span id="optimize_local_cobyla-35"><a href="#optimize_local_cobyla-35"><span class="linenos"> 35</span></a>                          <span class="p">,</span> <span class="n">revert_score_sign</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="optimize_local_cobyla-36"><a href="#optimize_local_cobyla-36"><span class="linenos"> 36</span></a>                          <span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="optimize_local_cobyla-37"><a href="#optimize_local_cobyla-37"><span class="linenos"> 37</span></a>                          <span class="p">,</span> <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="optimize_local_cobyla-38"><a href="#optimize_local_cobyla-38"><span class="linenos"> 38</span></a>                          <span class="p">,</span> <span class="n">iters_epoch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span>
</span><span id="optimize_local_cobyla-39"><a href="#optimize_local_cobyla-39"><span class="linenos"> 39</span></a>                          <span class="p">,</span> <span class="n">error_score</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e+12</span>
</span><span id="optimize_local_cobyla-40"><a href="#optimize_local_cobyla-40"><span class="linenos"> 40</span></a>                          <span class="p">,</span> <span class="n">ftol_abs</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">.01</span><span class="p">):</span>
</span><span id="optimize_local_cobyla-41"><a href="#optimize_local_cobyla-41"><span class="linenos"> 41</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="optimize_local_cobyla-42"><a href="#optimize_local_cobyla-42"><span class="linenos"> 42</span></a><span class="sd">    Wrapper for COBYLA constrained optimization by local approximations algorithm (local). COBYLA</span>
</span><span id="optimize_local_cobyla-43"><a href="#optimize_local_cobyla-43"><span class="linenos"> 43</span></a><span class="sd">    is derivative-free, so no analytical gradient is required.</span>
</span><span id="optimize_local_cobyla-44"><a href="#optimize_local_cobyla-44"><span class="linenos"> 44</span></a>
</span><span id="optimize_local_cobyla-45"><a href="#optimize_local_cobyla-45"><span class="linenos"> 45</span></a><span class="sd">    COBYLA minimizes score, so be careful to revert score if it is designed as maximizer before use</span>
</span><span id="optimize_local_cobyla-46"><a href="#optimize_local_cobyla-46"><span class="linenos"> 46</span></a><span class="sd">    or with argument `revert_score_sign=True`.</span>
</span><span id="optimize_local_cobyla-47"><a href="#optimize_local_cobyla-47"><span class="linenos"> 47</span></a>
</span><span id="optimize_local_cobyla-48"><a href="#optimize_local_cobyla-48"><span class="linenos"> 48</span></a><span class="sd">    Epochs are required to shuffle params a bit and to help algo get out from local optimum (sometimes)</span>
</span><span id="optimize_local_cobyla-49"><a href="#optimize_local_cobyla-49"><span class="linenos"> 49</span></a><span class="sd">    and to speed up calculation.</span>
</span><span id="optimize_local_cobyla-50"><a href="#optimize_local_cobyla-50"><span class="linenos"> 50</span></a>
</span><span id="optimize_local_cobyla-51"><a href="#optimize_local_cobyla-51"><span class="linenos"> 51</span></a><span class="sd">    Early stop threshold is defined as minimum absolute score gain per iteration. However, algo doesn&#39;t</span>
</span><span id="optimize_local_cobyla-52"><a href="#optimize_local_cobyla-52"><span class="linenos"> 52</span></a><span class="sd">    respect it directly, so don&#39;t be upset to see it working with much lesser gain per iteration.</span>
</span><span id="optimize_local_cobyla-53"><a href="#optimize_local_cobyla-53"><span class="linenos"> 53</span></a>
</span><span id="optimize_local_cobyla-54"><a href="#optimize_local_cobyla-54"><span class="linenos"> 54</span></a><span class="sd">    Local algorithms could be sensitive to starting (initial) values and to the number of optimising</span>
</span><span id="optimize_local_cobyla-55"><a href="#optimize_local_cobyla-55"><span class="linenos"> 55</span></a><span class="sd">    params. If params number is big enough (say, dozens) it is better to use it chunks, tuning</span>
</span><span id="optimize_local_cobyla-56"><a href="#optimize_local_cobyla-56"><span class="linenos"> 56</span></a><span class="sd">    one portion of params after another. Params for every chunk should be chosen wisely and not</span>
</span><span id="optimize_local_cobyla-57"><a href="#optimize_local_cobyla-57"><span class="linenos"> 57</span></a><span class="sd">    just first 10 or 20 params, them second 10 or 20 etc.</span>
</span><span id="optimize_local_cobyla-58"><a href="#optimize_local_cobyla-58"><span class="linenos"> 58</span></a>
</span><span id="optimize_local_cobyla-59"><a href="#optimize_local_cobyla-59"><span class="linenos"> 59</span></a><span class="sd">    Nlopt COBYLA implementation is preferred before `scipy.optimize.minimize(method=&#39;COBYLA&#39;)` because</span>
</span><span id="optimize_local_cobyla-60"><a href="#optimize_local_cobyla-60"><span class="linenos"> 60</span></a><span class="sd">    latter doesn&#39;t respect constraints accurately.</span>
</span><span id="optimize_local_cobyla-61"><a href="#optimize_local_cobyla-61"><span class="linenos"> 61</span></a>
</span><span id="optimize_local_cobyla-62"><a href="#optimize_local_cobyla-62"><span class="linenos"> 62</span></a><span class="sd">    However, Nlopt COBYLA has its own annoying issue. If improvement is (much?) below machine precision,</span>
</span><span id="optimize_local_cobyla-63"><a href="#optimize_local_cobyla-63"><span class="linenos"> 63</span></a><span class="sd">    it stops with error. We have some thoughts about workarounds to be implemented later, but as for now</span>
</span><span id="optimize_local_cobyla-64"><a href="#optimize_local_cobyla-64"><span class="linenos"> 64</span></a><span class="sd">    be aware starting values are not to close to the borders, e.g. 0.9999999999999 when border is 1.0.</span>
</span><span id="optimize_local_cobyla-65"><a href="#optimize_local_cobyla-65"><span class="linenos"> 65</span></a><span class="sd">    Move starting value a little further, e.g. to .95, and in most times it will be enough.</span>
</span><span id="optimize_local_cobyla-66"><a href="#optimize_local_cobyla-66"><span class="linenos"> 66</span></a>
</span><span id="optimize_local_cobyla-67"><a href="#optimize_local_cobyla-67"><span class="linenos"> 67</span></a><span class="sd">    :param ds: dataset</span>
</span><span id="optimize_local_cobyla-68"><a href="#optimize_local_cobyla-68"><span class="linenos"> 68</span></a><span class="sd">    :param model: Model object</span>
</span><span id="optimize_local_cobyla-69"><a href="#optimize_local_cobyla-69"><span class="linenos"> 69</span></a><span class="sd">    :param revert_score_sign: if the score is the bigger, the better; this algo minimizes score</span>
</span><span id="optimize_local_cobyla-70"><a href="#optimize_local_cobyla-70"><span class="linenos"> 70</span></a><span class="sd">    :param verbose: print diagnostic or progress information</span>
</span><span id="optimize_local_cobyla-71"><a href="#optimize_local_cobyla-71"><span class="linenos"> 71</span></a><span class="sd">    :param epochs: number of epochs</span>
</span><span id="optimize_local_cobyla-72"><a href="#optimize_local_cobyla-72"><span class="linenos"> 72</span></a><span class="sd">    :param iters_epoch: number of objective function calculations per epoch</span>
</span><span id="optimize_local_cobyla-73"><a href="#optimize_local_cobyla-73"><span class="linenos"> 73</span></a><span class="sd">    :param error_score: extremely big value to be used as score if fit_predict returns None (error)</span>
</span><span id="optimize_local_cobyla-74"><a href="#optimize_local_cobyla-74"><span class="linenos"> 74</span></a><span class="sd">    :param ftol_abs: early stop threshold: minimum absolute score gain per iteration, see description</span>
</span><span id="optimize_local_cobyla-75"><a href="#optimize_local_cobyla-75"><span class="linenos"> 75</span></a><span class="sd">    :return: tuned Model</span>
</span><span id="optimize_local_cobyla-76"><a href="#optimize_local_cobyla-76"><span class="linenos"> 76</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="optimize_local_cobyla-77"><a href="#optimize_local_cobyla-77"><span class="linenos"> 77</span></a>
</span><span id="optimize_local_cobyla-78"><a href="#optimize_local_cobyla-78"><span class="linenos"> 78</span></a>    <span class="n">params_subset</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="optimize_local_cobyla-79"><a href="#optimize_local_cobyla-79"><span class="linenos"> 79</span></a>
</span><span id="optimize_local_cobyla-80"><a href="#optimize_local_cobyla-80"><span class="linenos"> 80</span></a>    <span class="k">if</span> <span class="n">params_subset</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="optimize_local_cobyla-81"><a href="#optimize_local_cobyla-81"><span class="linenos"> 81</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No active non-fixed parameters to optimize&quot;</span><span class="p">)</span>
</span><span id="optimize_local_cobyla-82"><a href="#optimize_local_cobyla-82"><span class="linenos"> 82</span></a>        <span class="k">return</span> <span class="n">model</span>
</span><span id="optimize_local_cobyla-83"><a href="#optimize_local_cobyla-83"><span class="linenos"> 83</span></a>
</span><span id="optimize_local_cobyla-84"><a href="#optimize_local_cobyla-84"><span class="linenos"> 84</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
</span><span id="optimize_local_cobyla-85"><a href="#optimize_local_cobyla-85"><span class="linenos"> 85</span></a>
</span><span id="optimize_local_cobyla-86"><a href="#optimize_local_cobyla-86"><span class="linenos"> 86</span></a>        <span class="n">if_error</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="optimize_local_cobyla-87"><a href="#optimize_local_cobyla-87"><span class="linenos"> 87</span></a>
</span><span id="optimize_local_cobyla-88"><a href="#optimize_local_cobyla-88"><span class="linenos"> 88</span></a>        <span class="c1"># rebuild objective function every epoch to update model.conf</span>
</span><span id="optimize_local_cobyla-89"><a href="#optimize_local_cobyla-89"><span class="linenos"> 89</span></a>        <span class="n">objective_fun</span> <span class="o">=</span> <span class="n">ObjectiveFunction</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">ds</span>
</span><span id="optimize_local_cobyla-90"><a href="#optimize_local_cobyla-90"><span class="linenos"> 90</span></a>                                          <span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span>
</span><span id="optimize_local_cobyla-91"><a href="#optimize_local_cobyla-91"><span class="linenos"> 91</span></a>                                          <span class="p">,</span> <span class="n">revert_score_sign</span><span class="o">=</span><span class="n">revert_score_sign</span>
</span><span id="optimize_local_cobyla-92"><a href="#optimize_local_cobyla-92"><span class="linenos"> 92</span></a>                                          <span class="p">,</span> <span class="n">error_score</span><span class="o">=</span><span class="n">error_score</span>
</span><span id="optimize_local_cobyla-93"><a href="#optimize_local_cobyla-93"><span class="linenos"> 93</span></a>                                          <span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</span><span id="optimize_local_cobyla-94"><a href="#optimize_local_cobyla-94"><span class="linenos"> 94</span></a>
</span><span id="optimize_local_cobyla-95"><a href="#optimize_local_cobyla-95"><span class="linenos"> 95</span></a>        <span class="n">start_values</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="optimize_local_cobyla-96"><a href="#optimize_local_cobyla-96"><span class="linenos"> 96</span></a>
</span><span id="optimize_local_cobyla-97"><a href="#optimize_local_cobyla-97"><span class="linenos"> 97</span></a>        <span class="n">opt_obj</span> <span class="o">=</span> <span class="n">nlopt</span><span class="o">.</span><span class="n">opt</span><span class="p">(</span><span class="n">nlopt</span><span class="o">.</span><span class="n">LN_COBYLA</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_values</span><span class="p">))</span>
</span><span id="optimize_local_cobyla-98"><a href="#optimize_local_cobyla-98"><span class="linenos"> 98</span></a>
</span><span id="optimize_local_cobyla-99"><a href="#optimize_local_cobyla-99"><span class="linenos"> 99</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_min_objective</span><span class="p">(</span><span class="n">objective_fun</span><span class="p">)</span>
</span><span id="optimize_local_cobyla-100"><a href="#optimize_local_cobyla-100"><span class="linenos">100</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_lower_bounds</span><span class="p">(</span><span class="n">params_subset</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="optimize_local_cobyla-101"><a href="#optimize_local_cobyla-101"><span class="linenos">101</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_upper_bounds</span><span class="p">(</span><span class="n">params_subset</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="optimize_local_cobyla-102"><a href="#optimize_local_cobyla-102"><span class="linenos">102</span></a>
</span><span id="optimize_local_cobyla-103"><a href="#optimize_local_cobyla-103"><span class="linenos">103</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_ftol_abs</span><span class="p">(</span><span class="n">ftol_abs</span><span class="p">)</span>
</span><span id="optimize_local_cobyla-104"><a href="#optimize_local_cobyla-104"><span class="linenos">104</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_maxeval</span><span class="p">(</span><span class="n">iters_epoch</span><span class="p">)</span>
</span><span id="optimize_local_cobyla-105"><a href="#optimize_local_cobyla-105"><span class="linenos">105</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_maxtime</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="optimize_local_cobyla-106"><a href="#optimize_local_cobyla-106"><span class="linenos">106</span></a>
</span><span id="optimize_local_cobyla-107"><a href="#optimize_local_cobyla-107"><span class="linenos">107</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="optimize_local_cobyla-108"><a href="#optimize_local_cobyla-108"><span class="linenos">108</span></a>            <span class="n">rtrn</span> <span class="o">=</span> <span class="n">opt_obj</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">start_values</span><span class="p">)</span>
</span><span id="optimize_local_cobyla-109"><a href="#optimize_local_cobyla-109"><span class="linenos">109</span></a>        <span class="k">except</span> <span class="p">(</span><span class="n">nlopt</span><span class="o">.</span><span class="n">RoundoffLimited</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
</span><span id="optimize_local_cobyla-110"><a href="#optimize_local_cobyla-110"><span class="linenos">110</span></a>            <span class="n">rtrn</span> <span class="o">=</span> <span class="n">start_values</span>
</span><span id="optimize_local_cobyla-111"><a href="#optimize_local_cobyla-111"><span class="linenos">111</span></a>            <span class="n">if_error</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="optimize_local_cobyla-112"><a href="#optimize_local_cobyla-112"><span class="linenos">112</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Epoche terminated unsuccessfully due to ROUNDOFF error&quot;</span><span class="p">)</span>
</span><span id="optimize_local_cobyla-113"><a href="#optimize_local_cobyla-113"><span class="linenos">113</span></a>
</span><span id="optimize_local_cobyla-114"><a href="#optimize_local_cobyla-114"><span class="linenos">114</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Epoche &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; finished&#39;</span><span class="p">)</span>
</span><span id="optimize_local_cobyla-115"><a href="#optimize_local_cobyla-115"><span class="linenos">115</span></a>
</span><span id="optimize_local_cobyla-116"><a href="#optimize_local_cobyla-116"><span class="linenos">116</span></a>        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rtrn</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rtrn</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
</span><span id="optimize_local_cobyla-117"><a href="#optimize_local_cobyla-117"><span class="linenos">117</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtrn</span>
</span><span id="optimize_local_cobyla-118"><a href="#optimize_local_cobyla-118"><span class="linenos">118</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="optimize_local_cobyla-119"><a href="#optimize_local_cobyla-119"><span class="linenos">119</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Epoche did not terminate successfully&quot;</span><span class="p">)</span>
</span><span id="optimize_local_cobyla-120"><a href="#optimize_local_cobyla-120"><span class="linenos">120</span></a>
</span><span id="optimize_local_cobyla-121"><a href="#optimize_local_cobyla-121"><span class="linenos">121</span></a>        <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span>\
</span><span id="optimize_local_cobyla-122"><a href="#optimize_local_cobyla-122"><span class="linenos">122</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]][</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span>
</span><span id="optimize_local_cobyla-123"><a href="#optimize_local_cobyla-123"><span class="linenos">123</span></a>        <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span>\
</span><span id="optimize_local_cobyla-124"><a href="#optimize_local_cobyla-124"><span class="linenos">124</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]][</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span>
</span><span id="optimize_local_cobyla-125"><a href="#optimize_local_cobyla-125"><span class="linenos">125</span></a>
</span><span id="optimize_local_cobyla-126"><a href="#optimize_local_cobyla-126"><span class="linenos">126</span></a>        <span class="k">if</span> <span class="n">if_error</span><span class="p">:</span>
</span><span id="optimize_local_cobyla-127"><a href="#optimize_local_cobyla-127"><span class="linenos">127</span></a>            <span class="k">break</span>
</span><span id="optimize_local_cobyla-128"><a href="#optimize_local_cobyla-128"><span class="linenos">128</span></a>
</span><span id="optimize_local_cobyla-129"><a href="#optimize_local_cobyla-129"><span class="linenos">129</span></a>    <span class="k">return</span> <span class="n">model</span>
</span></pre></div>


            <div class="docstring"><p>Wrapper for COBYLA constrained optimization by local approximations algorithm (local). COBYLA
is derivative-free, so no analytical gradient is required.</p>

<p>COBYLA minimizes score, so be careful to revert score if it is designed as maximizer before use
or with argument <code>revert_score_sign=True</code>.</p>

<p>Epochs are required to shuffle params a bit and to help algo get out from local optimum (sometimes)
and to speed up calculation.</p>

<p>Early stop threshold is defined as minimum absolute score gain per iteration. However, algo doesn't
respect it directly, so don't be upset to see it working with much lesser gain per iteration.</p>

<p>Local algorithms could be sensitive to starting (initial) values and to the number of optimising
params. If params number is big enough (say, dozens) it is better to use it chunks, tuning
one portion of params after another. Params for every chunk should be chosen wisely and not
just first 10 or 20 params, them second 10 or 20 etc.</p>

<p>Nlopt COBYLA implementation is preferred before <code>scipy.optimize.minimize(method='COBYLA')</code> because
latter doesn't respect constraints accurately.</p>

<p>However, Nlopt COBYLA has its own annoying issue. If improvement is (much?) below machine precision,
it stops with error. We have some thoughts about workarounds to be implemented later, but as for now
be aware starting values are not to close to the borders, e.g. 0.9999999999999 when border is 1.0.
Move starting value a little further, e.g. to .95, and in most times it will be enough.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>ds</strong>:  dataset</li>
<li><strong>model</strong>:  Model object</li>
<li><strong>revert_score_sign</strong>:  if the score is the bigger, the better; this algo minimizes score</li>
<li><strong>verbose</strong>:  print diagnostic or progress information</li>
<li><strong>epochs</strong>:  number of epochs</li>
<li><strong>iters_epoch</strong>:  number of objective function calculations per epoch</li>
<li><strong>error_score</strong>:  extremely big value to be used as score if fit_predict returns None (error)</li>
<li><strong>ftol_abs: early stop threshold</strong>:  minimum absolute score gain per iteration, see description</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>tuned Model</p>
</blockquote>
</div>


                </section>
                <section id="optimize_local_bobyqa">
                            <input id="optimize_local_bobyqa-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">optimize_local_bobyqa</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">ds</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>,</span><span class="param">	<span class="n">model</span><span class="p">:</span> <span class="n"><a href="../model/model.html#Model">fermatrica.model.model.Model</a></span>,</span><span class="param">	<span class="n">revert_score_sign</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>,</span><span class="param">	<span class="n">iters_epoch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span>,</span><span class="param">	<span class="n">error_score</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1000000000000.0</span>,</span><span class="param">	<span class="n">ftol_abs</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="optimize_local_bobyqa-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#optimize_local_bobyqa"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="optimize_local_bobyqa-132"><a href="#optimize_local_bobyqa-132"><span class="linenos">132</span></a><span class="k">def</span> <span class="nf">optimize_local_bobyqa</span><span class="p">(</span><span class="n">ds</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
</span><span id="optimize_local_bobyqa-133"><a href="#optimize_local_bobyqa-133"><span class="linenos">133</span></a>                          <span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="s2">&quot;Model&quot;</span>
</span><span id="optimize_local_bobyqa-134"><a href="#optimize_local_bobyqa-134"><span class="linenos">134</span></a>                          <span class="p">,</span> <span class="n">revert_score_sign</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="optimize_local_bobyqa-135"><a href="#optimize_local_bobyqa-135"><span class="linenos">135</span></a>                          <span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="optimize_local_bobyqa-136"><a href="#optimize_local_bobyqa-136"><span class="linenos">136</span></a>                          <span class="p">,</span> <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="optimize_local_bobyqa-137"><a href="#optimize_local_bobyqa-137"><span class="linenos">137</span></a>                          <span class="p">,</span> <span class="n">iters_epoch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span>
</span><span id="optimize_local_bobyqa-138"><a href="#optimize_local_bobyqa-138"><span class="linenos">138</span></a>                          <span class="p">,</span> <span class="n">error_score</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e+12</span>
</span><span id="optimize_local_bobyqa-139"><a href="#optimize_local_bobyqa-139"><span class="linenos">139</span></a>                          <span class="p">,</span> <span class="n">ftol_abs</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">.01</span><span class="p">):</span>
</span><span id="optimize_local_bobyqa-140"><a href="#optimize_local_bobyqa-140"><span class="linenos">140</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="optimize_local_bobyqa-141"><a href="#optimize_local_bobyqa-141"><span class="linenos">141</span></a><span class="sd">    Wrapper for BOBYQA constrained optimization by local approximations algorithm (local). BOBYQA</span>
</span><span id="optimize_local_bobyqa-142"><a href="#optimize_local_bobyqa-142"><span class="linenos">142</span></a><span class="sd">    is derivative-free, so no analytical gradient is required.</span>
</span><span id="optimize_local_bobyqa-143"><a href="#optimize_local_bobyqa-143"><span class="linenos">143</span></a>
</span><span id="optimize_local_bobyqa-144"><a href="#optimize_local_bobyqa-144"><span class="linenos">144</span></a><span class="sd">    BOBYQA minimizes score, so be careful to revert score if it is designed as maximizer before use</span>
</span><span id="optimize_local_bobyqa-145"><a href="#optimize_local_bobyqa-145"><span class="linenos">145</span></a><span class="sd">    or with argument `revert_score_sign=True`.</span>
</span><span id="optimize_local_bobyqa-146"><a href="#optimize_local_bobyqa-146"><span class="linenos">146</span></a>
</span><span id="optimize_local_bobyqa-147"><a href="#optimize_local_bobyqa-147"><span class="linenos">147</span></a><span class="sd">    Epochs are required to shuffle params a bit and to help algo get out from local optimum (sometimes)</span>
</span><span id="optimize_local_bobyqa-148"><a href="#optimize_local_bobyqa-148"><span class="linenos">148</span></a><span class="sd">    and to speed up calculation.</span>
</span><span id="optimize_local_bobyqa-149"><a href="#optimize_local_bobyqa-149"><span class="linenos">149</span></a>
</span><span id="optimize_local_bobyqa-150"><a href="#optimize_local_bobyqa-150"><span class="linenos">150</span></a><span class="sd">    Early stop threshold is defined as minimum absolute score gain per iteration. However, algo doesn&#39;t</span>
</span><span id="optimize_local_bobyqa-151"><a href="#optimize_local_bobyqa-151"><span class="linenos">151</span></a><span class="sd">    respect it directly, so don&#39;t be upset to see it working with much lesser gain per iteration.</span>
</span><span id="optimize_local_bobyqa-152"><a href="#optimize_local_bobyqa-152"><span class="linenos">152</span></a>
</span><span id="optimize_local_bobyqa-153"><a href="#optimize_local_bobyqa-153"><span class="linenos">153</span></a><span class="sd">    Local algorithms could be sensitive to starting (initial) values and to the number of optimising</span>
</span><span id="optimize_local_bobyqa-154"><a href="#optimize_local_bobyqa-154"><span class="linenos">154</span></a><span class="sd">    params. If params number is big enough (say, dozens) it is better to use it chunks, tuning</span>
</span><span id="optimize_local_bobyqa-155"><a href="#optimize_local_bobyqa-155"><span class="linenos">155</span></a><span class="sd">    one portion of params after another. Params for every chunk should be chosen wisely and not</span>
</span><span id="optimize_local_bobyqa-156"><a href="#optimize_local_bobyqa-156"><span class="linenos">156</span></a><span class="sd">    just first 10 or 20 params, them second 10 or 20 etc.</span>
</span><span id="optimize_local_bobyqa-157"><a href="#optimize_local_bobyqa-157"><span class="linenos">157</span></a>
</span><span id="optimize_local_bobyqa-158"><a href="#optimize_local_bobyqa-158"><span class="linenos">158</span></a><span class="sd">    Nlopt BOBYQA implementation is preferred before `scipy.optimize.minimize(method=&#39;BOBYQA&#39;)` because</span>
</span><span id="optimize_local_bobyqa-159"><a href="#optimize_local_bobyqa-159"><span class="linenos">159</span></a><span class="sd">    latter doesn&#39;t respect constraints accurately.</span>
</span><span id="optimize_local_bobyqa-160"><a href="#optimize_local_bobyqa-160"><span class="linenos">160</span></a>
</span><span id="optimize_local_bobyqa-161"><a href="#optimize_local_bobyqa-161"><span class="linenos">161</span></a><span class="sd">    However, Nlopt BOBYQA has its own annoying issue. If improvement is (much?) below machine precision,</span>
</span><span id="optimize_local_bobyqa-162"><a href="#optimize_local_bobyqa-162"><span class="linenos">162</span></a><span class="sd">    it stops with error. We have some thoughts about workarounds to be implemented later, but as for now</span>
</span><span id="optimize_local_bobyqa-163"><a href="#optimize_local_bobyqa-163"><span class="linenos">163</span></a><span class="sd">    be aware starting values are not to close to the borders, e.g. 0.9999999999999 when border is 1.0.</span>
</span><span id="optimize_local_bobyqa-164"><a href="#optimize_local_bobyqa-164"><span class="linenos">164</span></a><span class="sd">    Move starting value a little further, e.g. to .95, and in most times it will be enough.</span>
</span><span id="optimize_local_bobyqa-165"><a href="#optimize_local_bobyqa-165"><span class="linenos">165</span></a>
</span><span id="optimize_local_bobyqa-166"><a href="#optimize_local_bobyqa-166"><span class="linenos">166</span></a><span class="sd">    :param ds: dataset</span>
</span><span id="optimize_local_bobyqa-167"><a href="#optimize_local_bobyqa-167"><span class="linenos">167</span></a><span class="sd">    :param model: Model object</span>
</span><span id="optimize_local_bobyqa-168"><a href="#optimize_local_bobyqa-168"><span class="linenos">168</span></a><span class="sd">    :param revert_score_sign: if the score is the bigger, the better; this algo minimizes score</span>
</span><span id="optimize_local_bobyqa-169"><a href="#optimize_local_bobyqa-169"><span class="linenos">169</span></a><span class="sd">    :param verbose: print diagnostic or progress information</span>
</span><span id="optimize_local_bobyqa-170"><a href="#optimize_local_bobyqa-170"><span class="linenos">170</span></a><span class="sd">    :param epochs: number of epochs</span>
</span><span id="optimize_local_bobyqa-171"><a href="#optimize_local_bobyqa-171"><span class="linenos">171</span></a><span class="sd">    :param iters_epoch: number of objective function calculations per epoch</span>
</span><span id="optimize_local_bobyqa-172"><a href="#optimize_local_bobyqa-172"><span class="linenos">172</span></a><span class="sd">    :param error_score: extremely big value to be used as score if fit_predict returns None (error)</span>
</span><span id="optimize_local_bobyqa-173"><a href="#optimize_local_bobyqa-173"><span class="linenos">173</span></a><span class="sd">    :param ftol_abs: early stop threshold: minimum absolute score gain per iteration, see description</span>
</span><span id="optimize_local_bobyqa-174"><a href="#optimize_local_bobyqa-174"><span class="linenos">174</span></a><span class="sd">    :return: tuned Model</span>
</span><span id="optimize_local_bobyqa-175"><a href="#optimize_local_bobyqa-175"><span class="linenos">175</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="optimize_local_bobyqa-176"><a href="#optimize_local_bobyqa-176"><span class="linenos">176</span></a>
</span><span id="optimize_local_bobyqa-177"><a href="#optimize_local_bobyqa-177"><span class="linenos">177</span></a>    <span class="n">params_subset</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="optimize_local_bobyqa-178"><a href="#optimize_local_bobyqa-178"><span class="linenos">178</span></a>
</span><span id="optimize_local_bobyqa-179"><a href="#optimize_local_bobyqa-179"><span class="linenos">179</span></a>    <span class="k">if</span> <span class="n">params_subset</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="optimize_local_bobyqa-180"><a href="#optimize_local_bobyqa-180"><span class="linenos">180</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No active non-fixed parameters to optimize&quot;</span><span class="p">)</span>
</span><span id="optimize_local_bobyqa-181"><a href="#optimize_local_bobyqa-181"><span class="linenos">181</span></a>        <span class="k">return</span> <span class="n">model</span>
</span><span id="optimize_local_bobyqa-182"><a href="#optimize_local_bobyqa-182"><span class="linenos">182</span></a>
</span><span id="optimize_local_bobyqa-183"><a href="#optimize_local_bobyqa-183"><span class="linenos">183</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
</span><span id="optimize_local_bobyqa-184"><a href="#optimize_local_bobyqa-184"><span class="linenos">184</span></a>
</span><span id="optimize_local_bobyqa-185"><a href="#optimize_local_bobyqa-185"><span class="linenos">185</span></a>        <span class="n">if_error</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="optimize_local_bobyqa-186"><a href="#optimize_local_bobyqa-186"><span class="linenos">186</span></a>
</span><span id="optimize_local_bobyqa-187"><a href="#optimize_local_bobyqa-187"><span class="linenos">187</span></a>        <span class="c1"># rebuild objective function every epoch to update model.conf</span>
</span><span id="optimize_local_bobyqa-188"><a href="#optimize_local_bobyqa-188"><span class="linenos">188</span></a>        <span class="n">objective_fun</span> <span class="o">=</span> <span class="n">ObjectiveFunction</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">ds</span>
</span><span id="optimize_local_bobyqa-189"><a href="#optimize_local_bobyqa-189"><span class="linenos">189</span></a>                                          <span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span>
</span><span id="optimize_local_bobyqa-190"><a href="#optimize_local_bobyqa-190"><span class="linenos">190</span></a>                                          <span class="p">,</span> <span class="n">revert_score_sign</span><span class="o">=</span><span class="n">revert_score_sign</span>
</span><span id="optimize_local_bobyqa-191"><a href="#optimize_local_bobyqa-191"><span class="linenos">191</span></a>                                          <span class="p">,</span> <span class="n">error_score</span><span class="o">=</span><span class="n">error_score</span>
</span><span id="optimize_local_bobyqa-192"><a href="#optimize_local_bobyqa-192"><span class="linenos">192</span></a>                                          <span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</span><span id="optimize_local_bobyqa-193"><a href="#optimize_local_bobyqa-193"><span class="linenos">193</span></a>
</span><span id="optimize_local_bobyqa-194"><a href="#optimize_local_bobyqa-194"><span class="linenos">194</span></a>        <span class="n">start_values</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="optimize_local_bobyqa-195"><a href="#optimize_local_bobyqa-195"><span class="linenos">195</span></a>
</span><span id="optimize_local_bobyqa-196"><a href="#optimize_local_bobyqa-196"><span class="linenos">196</span></a>        <span class="n">opt_obj</span> <span class="o">=</span> <span class="n">nlopt</span><span class="o">.</span><span class="n">opt</span><span class="p">(</span><span class="n">nlopt</span><span class="o">.</span><span class="n">LN_BOBYQA</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_values</span><span class="p">))</span>
</span><span id="optimize_local_bobyqa-197"><a href="#optimize_local_bobyqa-197"><span class="linenos">197</span></a>
</span><span id="optimize_local_bobyqa-198"><a href="#optimize_local_bobyqa-198"><span class="linenos">198</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_min_objective</span><span class="p">(</span><span class="n">objective_fun</span><span class="p">)</span>
</span><span id="optimize_local_bobyqa-199"><a href="#optimize_local_bobyqa-199"><span class="linenos">199</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_lower_bounds</span><span class="p">(</span><span class="n">params_subset</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="optimize_local_bobyqa-200"><a href="#optimize_local_bobyqa-200"><span class="linenos">200</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_upper_bounds</span><span class="p">(</span><span class="n">params_subset</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="optimize_local_bobyqa-201"><a href="#optimize_local_bobyqa-201"><span class="linenos">201</span></a>
</span><span id="optimize_local_bobyqa-202"><a href="#optimize_local_bobyqa-202"><span class="linenos">202</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_ftol_abs</span><span class="p">(</span><span class="n">ftol_abs</span><span class="p">)</span>
</span><span id="optimize_local_bobyqa-203"><a href="#optimize_local_bobyqa-203"><span class="linenos">203</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_maxeval</span><span class="p">(</span><span class="n">iters_epoch</span><span class="p">)</span>
</span><span id="optimize_local_bobyqa-204"><a href="#optimize_local_bobyqa-204"><span class="linenos">204</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_maxtime</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="optimize_local_bobyqa-205"><a href="#optimize_local_bobyqa-205"><span class="linenos">205</span></a>
</span><span id="optimize_local_bobyqa-206"><a href="#optimize_local_bobyqa-206"><span class="linenos">206</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="optimize_local_bobyqa-207"><a href="#optimize_local_bobyqa-207"><span class="linenos">207</span></a>            <span class="n">rtrn</span> <span class="o">=</span> <span class="n">opt_obj</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">start_values</span><span class="p">)</span>
</span><span id="optimize_local_bobyqa-208"><a href="#optimize_local_bobyqa-208"><span class="linenos">208</span></a>        <span class="k">except</span> <span class="p">(</span><span class="n">nlopt</span><span class="o">.</span><span class="n">RoundoffLimited</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
</span><span id="optimize_local_bobyqa-209"><a href="#optimize_local_bobyqa-209"><span class="linenos">209</span></a>            <span class="n">rtrn</span> <span class="o">=</span> <span class="n">start_values</span>
</span><span id="optimize_local_bobyqa-210"><a href="#optimize_local_bobyqa-210"><span class="linenos">210</span></a>            <span class="n">if_error</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="optimize_local_bobyqa-211"><a href="#optimize_local_bobyqa-211"><span class="linenos">211</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Epoche terminated unsuccessfully due to ROUNDOFF error&quot;</span><span class="p">)</span>
</span><span id="optimize_local_bobyqa-212"><a href="#optimize_local_bobyqa-212"><span class="linenos">212</span></a>
</span><span id="optimize_local_bobyqa-213"><a href="#optimize_local_bobyqa-213"><span class="linenos">213</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Epoche &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; finished&#39;</span><span class="p">)</span>
</span><span id="optimize_local_bobyqa-214"><a href="#optimize_local_bobyqa-214"><span class="linenos">214</span></a>
</span><span id="optimize_local_bobyqa-215"><a href="#optimize_local_bobyqa-215"><span class="linenos">215</span></a>        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rtrn</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rtrn</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
</span><span id="optimize_local_bobyqa-216"><a href="#optimize_local_bobyqa-216"><span class="linenos">216</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtrn</span>
</span><span id="optimize_local_bobyqa-217"><a href="#optimize_local_bobyqa-217"><span class="linenos">217</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="optimize_local_bobyqa-218"><a href="#optimize_local_bobyqa-218"><span class="linenos">218</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Epoche did not terminate successfully&quot;</span><span class="p">)</span>
</span><span id="optimize_local_bobyqa-219"><a href="#optimize_local_bobyqa-219"><span class="linenos">219</span></a>
</span><span id="optimize_local_bobyqa-220"><a href="#optimize_local_bobyqa-220"><span class="linenos">220</span></a>        <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span>\
</span><span id="optimize_local_bobyqa-221"><a href="#optimize_local_bobyqa-221"><span class="linenos">221</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]][</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span>
</span><span id="optimize_local_bobyqa-222"><a href="#optimize_local_bobyqa-222"><span class="linenos">222</span></a>        <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span>\
</span><span id="optimize_local_bobyqa-223"><a href="#optimize_local_bobyqa-223"><span class="linenos">223</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]][</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span>
</span><span id="optimize_local_bobyqa-224"><a href="#optimize_local_bobyqa-224"><span class="linenos">224</span></a>
</span><span id="optimize_local_bobyqa-225"><a href="#optimize_local_bobyqa-225"><span class="linenos">225</span></a>        <span class="k">if</span> <span class="n">if_error</span><span class="p">:</span>
</span><span id="optimize_local_bobyqa-226"><a href="#optimize_local_bobyqa-226"><span class="linenos">226</span></a>            <span class="k">break</span>
</span><span id="optimize_local_bobyqa-227"><a href="#optimize_local_bobyqa-227"><span class="linenos">227</span></a>
</span><span id="optimize_local_bobyqa-228"><a href="#optimize_local_bobyqa-228"><span class="linenos">228</span></a>    <span class="k">return</span> <span class="n">model</span>
</span></pre></div>


            <div class="docstring"><p>Wrapper for BOBYQA constrained optimization by local approximations algorithm (local). BOBYQA
is derivative-free, so no analytical gradient is required.</p>

<p>BOBYQA minimizes score, so be careful to revert score if it is designed as maximizer before use
or with argument <code>revert_score_sign=True</code>.</p>

<p>Epochs are required to shuffle params a bit and to help algo get out from local optimum (sometimes)
and to speed up calculation.</p>

<p>Early stop threshold is defined as minimum absolute score gain per iteration. However, algo doesn't
respect it directly, so don't be upset to see it working with much lesser gain per iteration.</p>

<p>Local algorithms could be sensitive to starting (initial) values and to the number of optimising
params. If params number is big enough (say, dozens) it is better to use it chunks, tuning
one portion of params after another. Params for every chunk should be chosen wisely and not
just first 10 or 20 params, them second 10 or 20 etc.</p>

<p>Nlopt BOBYQA implementation is preferred before <code>scipy.optimize.minimize(method='BOBYQA')</code> because
latter doesn't respect constraints accurately.</p>

<p>However, Nlopt BOBYQA has its own annoying issue. If improvement is (much?) below machine precision,
it stops with error. We have some thoughts about workarounds to be implemented later, but as for now
be aware starting values are not to close to the borders, e.g. 0.9999999999999 when border is 1.0.
Move starting value a little further, e.g. to .95, and in most times it will be enough.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>ds</strong>:  dataset</li>
<li><strong>model</strong>:  Model object</li>
<li><strong>revert_score_sign</strong>:  if the score is the bigger, the better; this algo minimizes score</li>
<li><strong>verbose</strong>:  print diagnostic or progress information</li>
<li><strong>epochs</strong>:  number of epochs</li>
<li><strong>iters_epoch</strong>:  number of objective function calculations per epoch</li>
<li><strong>error_score</strong>:  extremely big value to be used as score if fit_predict returns None (error)</li>
<li><strong>ftol_abs: early stop threshold</strong>:  minimum absolute score gain per iteration, see description</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>tuned Model</p>
</blockquote>
</div>


                </section>
                <section id="optimize_local_sbplx">
                            <input id="optimize_local_sbplx-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">optimize_local_sbplx</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">ds</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>,</span><span class="param">	<span class="n">model</span><span class="p">:</span> <span class="n"><a href="../model/model.html#Model">fermatrica.model.model.Model</a></span>,</span><span class="param">	<span class="n">revert_score_sign</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>,</span><span class="param">	<span class="n">iters_epoch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span>,</span><span class="param">	<span class="n">error_score</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1000000000000.0</span>,</span><span class="param">	<span class="n">ftol_abs</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="optimize_local_sbplx-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#optimize_local_sbplx"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="optimize_local_sbplx-231"><a href="#optimize_local_sbplx-231"><span class="linenos">231</span></a><span class="k">def</span> <span class="nf">optimize_local_sbplx</span><span class="p">(</span><span class="n">ds</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
</span><span id="optimize_local_sbplx-232"><a href="#optimize_local_sbplx-232"><span class="linenos">232</span></a>                         <span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="s2">&quot;Model&quot;</span>
</span><span id="optimize_local_sbplx-233"><a href="#optimize_local_sbplx-233"><span class="linenos">233</span></a>                         <span class="p">,</span> <span class="n">revert_score_sign</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="optimize_local_sbplx-234"><a href="#optimize_local_sbplx-234"><span class="linenos">234</span></a>                         <span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="optimize_local_sbplx-235"><a href="#optimize_local_sbplx-235"><span class="linenos">235</span></a>                         <span class="p">,</span> <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="optimize_local_sbplx-236"><a href="#optimize_local_sbplx-236"><span class="linenos">236</span></a>                         <span class="p">,</span> <span class="n">iters_epoch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span>
</span><span id="optimize_local_sbplx-237"><a href="#optimize_local_sbplx-237"><span class="linenos">237</span></a>                         <span class="p">,</span> <span class="n">error_score</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e+12</span>
</span><span id="optimize_local_sbplx-238"><a href="#optimize_local_sbplx-238"><span class="linenos">238</span></a>                         <span class="p">,</span> <span class="n">ftol_abs</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">.01</span><span class="p">):</span>
</span><span id="optimize_local_sbplx-239"><a href="#optimize_local_sbplx-239"><span class="linenos">239</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="optimize_local_sbplx-240"><a href="#optimize_local_sbplx-240"><span class="linenos">240</span></a><span class="sd">    Wrapper for Sblpx / Subplex constrained optimization by local approximations algorithm (local). Sblpx / Subplex</span>
</span><span id="optimize_local_sbplx-241"><a href="#optimize_local_sbplx-241"><span class="linenos">241</span></a><span class="sd">    is derivative-free, so no analytical gradient is required.</span>
</span><span id="optimize_local_sbplx-242"><a href="#optimize_local_sbplx-242"><span class="linenos">242</span></a>
</span><span id="optimize_local_sbplx-243"><a href="#optimize_local_sbplx-243"><span class="linenos">243</span></a><span class="sd">    Sblpx / Subplex minimizes score, so be careful to revert score if it is designed as maximizer before use</span>
</span><span id="optimize_local_sbplx-244"><a href="#optimize_local_sbplx-244"><span class="linenos">244</span></a><span class="sd">    or with argument `revert_score_sign=True`.</span>
</span><span id="optimize_local_sbplx-245"><a href="#optimize_local_sbplx-245"><span class="linenos">245</span></a>
</span><span id="optimize_local_sbplx-246"><a href="#optimize_local_sbplx-246"><span class="linenos">246</span></a><span class="sd">    Epochs are required to shuffle params a bit and to help algo get out from local optimum (sometimes)</span>
</span><span id="optimize_local_sbplx-247"><a href="#optimize_local_sbplx-247"><span class="linenos">247</span></a><span class="sd">    and to speed up calculation.</span>
</span><span id="optimize_local_sbplx-248"><a href="#optimize_local_sbplx-248"><span class="linenos">248</span></a>
</span><span id="optimize_local_sbplx-249"><a href="#optimize_local_sbplx-249"><span class="linenos">249</span></a><span class="sd">    Early stop threshold is defined as minimum absolute score gain per iteration. However, algo doesn&#39;t</span>
</span><span id="optimize_local_sbplx-250"><a href="#optimize_local_sbplx-250"><span class="linenos">250</span></a><span class="sd">    respect it directly, so don&#39;t be upset to see it working with much lesser gain per iteration.</span>
</span><span id="optimize_local_sbplx-251"><a href="#optimize_local_sbplx-251"><span class="linenos">251</span></a>
</span><span id="optimize_local_sbplx-252"><a href="#optimize_local_sbplx-252"><span class="linenos">252</span></a><span class="sd">    Local algorithms could be sensitive to starting (initial) values and to the number of optimising</span>
</span><span id="optimize_local_sbplx-253"><a href="#optimize_local_sbplx-253"><span class="linenos">253</span></a><span class="sd">    params. If params number is big enough (say, dozens) it is better to use it chunks, tuning</span>
</span><span id="optimize_local_sbplx-254"><a href="#optimize_local_sbplx-254"><span class="linenos">254</span></a><span class="sd">    one portion of params after another. Params for every chunk should be chosen wisely and not</span>
</span><span id="optimize_local_sbplx-255"><a href="#optimize_local_sbplx-255"><span class="linenos">255</span></a><span class="sd">    just first 10 or 20 params, them second 10 or 20 etc.</span>
</span><span id="optimize_local_sbplx-256"><a href="#optimize_local_sbplx-256"><span class="linenos">256</span></a>
</span><span id="optimize_local_sbplx-257"><a href="#optimize_local_sbplx-257"><span class="linenos">257</span></a><span class="sd">    Nlopt Sblpx / Subplex implementation is preferred before `scipy.optimize.minimize(method=&#39;Sblpx / Subplex&#39;)` because</span>
</span><span id="optimize_local_sbplx-258"><a href="#optimize_local_sbplx-258"><span class="linenos">258</span></a><span class="sd">    latter doesn&#39;t respect constraints accurately.</span>
</span><span id="optimize_local_sbplx-259"><a href="#optimize_local_sbplx-259"><span class="linenos">259</span></a>
</span><span id="optimize_local_sbplx-260"><a href="#optimize_local_sbplx-260"><span class="linenos">260</span></a><span class="sd">    However, Nlopt Sblpx / Subplex has its own annoying issue. If improvement is (much?) below machine precision,</span>
</span><span id="optimize_local_sbplx-261"><a href="#optimize_local_sbplx-261"><span class="linenos">261</span></a><span class="sd">    it stops with error. We have some thoughts about workarounds to be implemented later, but as for now</span>
</span><span id="optimize_local_sbplx-262"><a href="#optimize_local_sbplx-262"><span class="linenos">262</span></a><span class="sd">    be aware starting values are not to close to the borders, e.g. 0.9999999999999 when border is 1.0.</span>
</span><span id="optimize_local_sbplx-263"><a href="#optimize_local_sbplx-263"><span class="linenos">263</span></a><span class="sd">    Move starting value a little further, e.g. to .95, and in most times it will be enough.</span>
</span><span id="optimize_local_sbplx-264"><a href="#optimize_local_sbplx-264"><span class="linenos">264</span></a>
</span><span id="optimize_local_sbplx-265"><a href="#optimize_local_sbplx-265"><span class="linenos">265</span></a><span class="sd">    :param ds: dataset</span>
</span><span id="optimize_local_sbplx-266"><a href="#optimize_local_sbplx-266"><span class="linenos">266</span></a><span class="sd">    :param model: Model object</span>
</span><span id="optimize_local_sbplx-267"><a href="#optimize_local_sbplx-267"><span class="linenos">267</span></a><span class="sd">    :param revert_score_sign: if the score is the bigger, the better; this algo minimizes score</span>
</span><span id="optimize_local_sbplx-268"><a href="#optimize_local_sbplx-268"><span class="linenos">268</span></a><span class="sd">    :param verbose: print diagnostic or progress information</span>
</span><span id="optimize_local_sbplx-269"><a href="#optimize_local_sbplx-269"><span class="linenos">269</span></a><span class="sd">    :param epochs: number of epochs</span>
</span><span id="optimize_local_sbplx-270"><a href="#optimize_local_sbplx-270"><span class="linenos">270</span></a><span class="sd">    :param iters_epoch: number of objective function calculations per epoch</span>
</span><span id="optimize_local_sbplx-271"><a href="#optimize_local_sbplx-271"><span class="linenos">271</span></a><span class="sd">    :param error_score: extremely big value to be used as score if fit_predict returns None (error)</span>
</span><span id="optimize_local_sbplx-272"><a href="#optimize_local_sbplx-272"><span class="linenos">272</span></a><span class="sd">    :param ftol_abs: early stop threshold: minimum absolute score gain per iteration, see description</span>
</span><span id="optimize_local_sbplx-273"><a href="#optimize_local_sbplx-273"><span class="linenos">273</span></a><span class="sd">    :return: tuned Model</span>
</span><span id="optimize_local_sbplx-274"><a href="#optimize_local_sbplx-274"><span class="linenos">274</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="optimize_local_sbplx-275"><a href="#optimize_local_sbplx-275"><span class="linenos">275</span></a>
</span><span id="optimize_local_sbplx-276"><a href="#optimize_local_sbplx-276"><span class="linenos">276</span></a>    <span class="n">params_subset</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="optimize_local_sbplx-277"><a href="#optimize_local_sbplx-277"><span class="linenos">277</span></a>
</span><span id="optimize_local_sbplx-278"><a href="#optimize_local_sbplx-278"><span class="linenos">278</span></a>    <span class="k">if</span> <span class="n">params_subset</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="optimize_local_sbplx-279"><a href="#optimize_local_sbplx-279"><span class="linenos">279</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No active non-fixed parameters to optimize&quot;</span><span class="p">)</span>
</span><span id="optimize_local_sbplx-280"><a href="#optimize_local_sbplx-280"><span class="linenos">280</span></a>        <span class="k">return</span> <span class="n">model</span>
</span><span id="optimize_local_sbplx-281"><a href="#optimize_local_sbplx-281"><span class="linenos">281</span></a>
</span><span id="optimize_local_sbplx-282"><a href="#optimize_local_sbplx-282"><span class="linenos">282</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
</span><span id="optimize_local_sbplx-283"><a href="#optimize_local_sbplx-283"><span class="linenos">283</span></a>
</span><span id="optimize_local_sbplx-284"><a href="#optimize_local_sbplx-284"><span class="linenos">284</span></a>        <span class="n">if_error</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="optimize_local_sbplx-285"><a href="#optimize_local_sbplx-285"><span class="linenos">285</span></a>
</span><span id="optimize_local_sbplx-286"><a href="#optimize_local_sbplx-286"><span class="linenos">286</span></a>        <span class="c1"># rebuild objective function every epoch to update model.conf</span>
</span><span id="optimize_local_sbplx-287"><a href="#optimize_local_sbplx-287"><span class="linenos">287</span></a>        <span class="n">objective_fun</span> <span class="o">=</span> <span class="n">ObjectiveFunction</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">ds</span>
</span><span id="optimize_local_sbplx-288"><a href="#optimize_local_sbplx-288"><span class="linenos">288</span></a>                                          <span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span>
</span><span id="optimize_local_sbplx-289"><a href="#optimize_local_sbplx-289"><span class="linenos">289</span></a>                                          <span class="p">,</span> <span class="n">revert_score_sign</span><span class="o">=</span><span class="n">revert_score_sign</span>
</span><span id="optimize_local_sbplx-290"><a href="#optimize_local_sbplx-290"><span class="linenos">290</span></a>                                          <span class="p">,</span> <span class="n">error_score</span><span class="o">=</span><span class="n">error_score</span>
</span><span id="optimize_local_sbplx-291"><a href="#optimize_local_sbplx-291"><span class="linenos">291</span></a>                                          <span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</span><span id="optimize_local_sbplx-292"><a href="#optimize_local_sbplx-292"><span class="linenos">292</span></a>
</span><span id="optimize_local_sbplx-293"><a href="#optimize_local_sbplx-293"><span class="linenos">293</span></a>        <span class="n">start_values</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="optimize_local_sbplx-294"><a href="#optimize_local_sbplx-294"><span class="linenos">294</span></a>
</span><span id="optimize_local_sbplx-295"><a href="#optimize_local_sbplx-295"><span class="linenos">295</span></a>        <span class="n">opt_obj</span> <span class="o">=</span> <span class="n">nlopt</span><span class="o">.</span><span class="n">opt</span><span class="p">(</span><span class="n">nlopt</span><span class="o">.</span><span class="n">LN_SBPLX</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_values</span><span class="p">))</span>
</span><span id="optimize_local_sbplx-296"><a href="#optimize_local_sbplx-296"><span class="linenos">296</span></a>
</span><span id="optimize_local_sbplx-297"><a href="#optimize_local_sbplx-297"><span class="linenos">297</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_min_objective</span><span class="p">(</span><span class="n">objective_fun</span><span class="p">)</span>
</span><span id="optimize_local_sbplx-298"><a href="#optimize_local_sbplx-298"><span class="linenos">298</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_lower_bounds</span><span class="p">(</span><span class="n">params_subset</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="optimize_local_sbplx-299"><a href="#optimize_local_sbplx-299"><span class="linenos">299</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_upper_bounds</span><span class="p">(</span><span class="n">params_subset</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="optimize_local_sbplx-300"><a href="#optimize_local_sbplx-300"><span class="linenos">300</span></a>
</span><span id="optimize_local_sbplx-301"><a href="#optimize_local_sbplx-301"><span class="linenos">301</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_ftol_abs</span><span class="p">(</span><span class="n">ftol_abs</span><span class="p">)</span>
</span><span id="optimize_local_sbplx-302"><a href="#optimize_local_sbplx-302"><span class="linenos">302</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_maxeval</span><span class="p">(</span><span class="n">iters_epoch</span><span class="p">)</span>
</span><span id="optimize_local_sbplx-303"><a href="#optimize_local_sbplx-303"><span class="linenos">303</span></a>        <span class="n">opt_obj</span><span class="o">.</span><span class="n">set_maxtime</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="optimize_local_sbplx-304"><a href="#optimize_local_sbplx-304"><span class="linenos">304</span></a>
</span><span id="optimize_local_sbplx-305"><a href="#optimize_local_sbplx-305"><span class="linenos">305</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="optimize_local_sbplx-306"><a href="#optimize_local_sbplx-306"><span class="linenos">306</span></a>            <span class="n">rtrn</span> <span class="o">=</span> <span class="n">opt_obj</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">start_values</span><span class="p">)</span>
</span><span id="optimize_local_sbplx-307"><a href="#optimize_local_sbplx-307"><span class="linenos">307</span></a>        <span class="k">except</span> <span class="p">(</span><span class="n">nlopt</span><span class="o">.</span><span class="n">RoundoffLimited</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
</span><span id="optimize_local_sbplx-308"><a href="#optimize_local_sbplx-308"><span class="linenos">308</span></a>            <span class="n">rtrn</span> <span class="o">=</span> <span class="n">start_values</span>
</span><span id="optimize_local_sbplx-309"><a href="#optimize_local_sbplx-309"><span class="linenos">309</span></a>            <span class="n">if_error</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="optimize_local_sbplx-310"><a href="#optimize_local_sbplx-310"><span class="linenos">310</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Epoche terminated unsuccessfully due to ROUNDOFF error&quot;</span><span class="p">)</span>
</span><span id="optimize_local_sbplx-311"><a href="#optimize_local_sbplx-311"><span class="linenos">311</span></a>
</span><span id="optimize_local_sbplx-312"><a href="#optimize_local_sbplx-312"><span class="linenos">312</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Epoche &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; finished&#39;</span><span class="p">)</span>
</span><span id="optimize_local_sbplx-313"><a href="#optimize_local_sbplx-313"><span class="linenos">313</span></a>
</span><span id="optimize_local_sbplx-314"><a href="#optimize_local_sbplx-314"><span class="linenos">314</span></a>        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rtrn</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rtrn</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
</span><span id="optimize_local_sbplx-315"><a href="#optimize_local_sbplx-315"><span class="linenos">315</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtrn</span>
</span><span id="optimize_local_sbplx-316"><a href="#optimize_local_sbplx-316"><span class="linenos">316</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="optimize_local_sbplx-317"><a href="#optimize_local_sbplx-317"><span class="linenos">317</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Epoche did not terminate successfully&quot;</span><span class="p">)</span>
</span><span id="optimize_local_sbplx-318"><a href="#optimize_local_sbplx-318"><span class="linenos">318</span></a>
</span><span id="optimize_local_sbplx-319"><a href="#optimize_local_sbplx-319"><span class="linenos">319</span></a>        <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span>\
</span><span id="optimize_local_sbplx-320"><a href="#optimize_local_sbplx-320"><span class="linenos">320</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]][</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span>
</span><span id="optimize_local_sbplx-321"><a href="#optimize_local_sbplx-321"><span class="linenos">321</span></a>        <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span>\
</span><span id="optimize_local_sbplx-322"><a href="#optimize_local_sbplx-322"><span class="linenos">322</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]][</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span>
</span><span id="optimize_local_sbplx-323"><a href="#optimize_local_sbplx-323"><span class="linenos">323</span></a>
</span><span id="optimize_local_sbplx-324"><a href="#optimize_local_sbplx-324"><span class="linenos">324</span></a>        <span class="k">if</span> <span class="n">if_error</span><span class="p">:</span>
</span><span id="optimize_local_sbplx-325"><a href="#optimize_local_sbplx-325"><span class="linenos">325</span></a>            <span class="k">break</span>
</span><span id="optimize_local_sbplx-326"><a href="#optimize_local_sbplx-326"><span class="linenos">326</span></a>
</span><span id="optimize_local_sbplx-327"><a href="#optimize_local_sbplx-327"><span class="linenos">327</span></a>    <span class="k">return</span> <span class="n">model</span>
</span></pre></div>


            <div class="docstring"><p>Wrapper for Sblpx / Subplex constrained optimization by local approximations algorithm (local). Sblpx / Subplex
is derivative-free, so no analytical gradient is required.</p>

<p>Sblpx / Subplex minimizes score, so be careful to revert score if it is designed as maximizer before use
or with argument <code>revert_score_sign=True</code>.</p>

<p>Epochs are required to shuffle params a bit and to help algo get out from local optimum (sometimes)
and to speed up calculation.</p>

<p>Early stop threshold is defined as minimum absolute score gain per iteration. However, algo doesn't
respect it directly, so don't be upset to see it working with much lesser gain per iteration.</p>

<p>Local algorithms could be sensitive to starting (initial) values and to the number of optimising
params. If params number is big enough (say, dozens) it is better to use it chunks, tuning
one portion of params after another. Params for every chunk should be chosen wisely and not
just first 10 or 20 params, them second 10 or 20 etc.</p>

<p>Nlopt Sblpx / Subplex implementation is preferred before <code>scipy.optimize.minimize(method='Sblpx / Subplex')</code> because
latter doesn't respect constraints accurately.</p>

<p>However, Nlopt Sblpx / Subplex has its own annoying issue. If improvement is (much?) below machine precision,
it stops with error. We have some thoughts about workarounds to be implemented later, but as for now
be aware starting values are not to close to the borders, e.g. 0.9999999999999 when border is 1.0.
Move starting value a little further, e.g. to .95, and in most times it will be enough.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>ds</strong>:  dataset</li>
<li><strong>model</strong>:  Model object</li>
<li><strong>revert_score_sign</strong>:  if the score is the bigger, the better; this algo minimizes score</li>
<li><strong>verbose</strong>:  print diagnostic or progress information</li>
<li><strong>epochs</strong>:  number of epochs</li>
<li><strong>iters_epoch</strong>:  number of objective function calculations per epoch</li>
<li><strong>error_score</strong>:  extremely big value to be used as score if fit_predict returns None (error)</li>
<li><strong>ftol_abs: early stop threshold</strong>:  minimum absolute score gain per iteration, see description</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>tuned Model</p>
</blockquote>
</div>


                </section>
                <section id="optimize_local_rbf">
                            <input id="optimize_local_rbf-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">optimize_local_rbf</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">ds</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>,</span><span class="param">	<span class="n">model</span><span class="p">:</span> <span class="n"><a href="../model/model.html#Model">fermatrica.model.model.Model</a></span>,</span><span class="param">	<span class="n">revert_score_sign</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>,</span><span class="param">	<span class="n">iters_epoch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span>,</span><span class="param">	<span class="n">error_score</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1000000000000.0</span>,</span><span class="param">	<span class="n">cores</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span>,</span><span class="param">	<span class="n">ftol_abs</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="optimize_local_rbf-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#optimize_local_rbf"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="optimize_local_rbf-330"><a href="#optimize_local_rbf-330"><span class="linenos">330</span></a><span class="k">def</span> <span class="nf">optimize_local_rbf</span><span class="p">(</span><span class="n">ds</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
</span><span id="optimize_local_rbf-331"><a href="#optimize_local_rbf-331"><span class="linenos">331</span></a>                       <span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="s2">&quot;Model&quot;</span>
</span><span id="optimize_local_rbf-332"><a href="#optimize_local_rbf-332"><span class="linenos">332</span></a>                       <span class="p">,</span> <span class="n">revert_score_sign</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="optimize_local_rbf-333"><a href="#optimize_local_rbf-333"><span class="linenos">333</span></a>                       <span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="optimize_local_rbf-334"><a href="#optimize_local_rbf-334"><span class="linenos">334</span></a>                       <span class="p">,</span> <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="optimize_local_rbf-335"><a href="#optimize_local_rbf-335"><span class="linenos">335</span></a>                       <span class="p">,</span> <span class="n">iters_epoch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span>
</span><span id="optimize_local_rbf-336"><a href="#optimize_local_rbf-336"><span class="linenos">336</span></a>                       <span class="p">,</span> <span class="n">error_score</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e+12</span>
</span><span id="optimize_local_rbf-337"><a href="#optimize_local_rbf-337"><span class="linenos">337</span></a>                       <span class="p">,</span> <span class="n">cores</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span>
</span><span id="optimize_local_rbf-338"><a href="#optimize_local_rbf-338"><span class="linenos">338</span></a>                       <span class="p">,</span> <span class="n">ftol_abs</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">.01</span><span class="p">):</span>
</span><span id="optimize_local_rbf-339"><a href="#optimize_local_rbf-339"><span class="linenos">339</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="optimize_local_rbf-340"><a href="#optimize_local_rbf-340"><span class="linenos">340</span></a><span class="sd">    Surrogate-model-based optimization with parallel evaluation.</span>
</span><span id="optimize_local_rbf-341"><a href="#optimize_local_rbf-341"><span class="linenos">341</span></a><span class="sd">    Bayesian optimization using RBF surrogate model and Latin Hypercube Sampling.</span>
</span><span id="optimize_local_rbf-342"><a href="#optimize_local_rbf-342"><span class="linenos">342</span></a>
</span><span id="optimize_local_rbf-343"><a href="#optimize_local_rbf-343"><span class="linenos">343</span></a><span class="sd">    :param ds: dataset</span>
</span><span id="optimize_local_rbf-344"><a href="#optimize_local_rbf-344"><span class="linenos">344</span></a><span class="sd">    :param model: Model object</span>
</span><span id="optimize_local_rbf-345"><a href="#optimize_local_rbf-345"><span class="linenos">345</span></a><span class="sd">    :param revert_score_sign: if the score is the bigger, the better; this algo minimizes score</span>
</span><span id="optimize_local_rbf-346"><a href="#optimize_local_rbf-346"><span class="linenos">346</span></a><span class="sd">    :param verbose: print diagnostic or progress information</span>
</span><span id="optimize_local_rbf-347"><a href="#optimize_local_rbf-347"><span class="linenos">347</span></a><span class="sd">    :param epochs: number of epochs</span>
</span><span id="optimize_local_rbf-348"><a href="#optimize_local_rbf-348"><span class="linenos">348</span></a><span class="sd">    :param iters_epoch: number of objective function calculations per epoch</span>
</span><span id="optimize_local_rbf-349"><a href="#optimize_local_rbf-349"><span class="linenos">349</span></a><span class="sd">    :param error_score: extremely big value to be used as score if fit_predict returns None (error)</span>
</span><span id="optimize_local_rbf-350"><a href="#optimize_local_rbf-350"><span class="linenos">350</span></a><span class="sd">    :param cores: processor cores to be used in parallel computing</span>
</span><span id="optimize_local_rbf-351"><a href="#optimize_local_rbf-351"><span class="linenos">351</span></a><span class="sd">    :param ftol_abs: early stop threshold: minimum absolute score gain per iteration, see description</span>
</span><span id="optimize_local_rbf-352"><a href="#optimize_local_rbf-352"><span class="linenos">352</span></a><span class="sd">    :return: tuned Model</span>
</span><span id="optimize_local_rbf-353"><a href="#optimize_local_rbf-353"><span class="linenos">353</span></a>
</span><span id="optimize_local_rbf-354"><a href="#optimize_local_rbf-354"><span class="linenos">354</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="optimize_local_rbf-355"><a href="#optimize_local_rbf-355"><span class="linenos">355</span></a>
</span><span id="optimize_local_rbf-356"><a href="#optimize_local_rbf-356"><span class="linenos">356</span></a>    <span class="n">params_subset</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="optimize_local_rbf-357"><a href="#optimize_local_rbf-357"><span class="linenos">357</span></a>    <span class="n">start_values</span> <span class="o">=</span> <span class="n">params_subset</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="optimize_local_rbf-358"><a href="#optimize_local_rbf-358"><span class="linenos">358</span></a>
</span><span id="optimize_local_rbf-359"><a href="#optimize_local_rbf-359"><span class="linenos">359</span></a>    <span class="k">if</span> <span class="n">params_subset</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="optimize_local_rbf-360"><a href="#optimize_local_rbf-360"><span class="linenos">360</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No active non-fixed parameters to optimize&quot;</span><span class="p">)</span>
</span><span id="optimize_local_rbf-361"><a href="#optimize_local_rbf-361"><span class="linenos">361</span></a>        <span class="k">return</span> <span class="n">model</span>
</span><span id="optimize_local_rbf-362"><a href="#optimize_local_rbf-362"><span class="linenos">362</span></a>
</span><span id="optimize_local_rbf-363"><a href="#optimize_local_rbf-363"><span class="linenos">363</span></a>    <span class="k">if</span> <span class="n">cores</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="optimize_local_rbf-364"><a href="#optimize_local_rbf-364"><span class="linenos">364</span></a>        <span class="n">cores</span> <span class="o">=</span> <span class="p">(</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="optimize_local_rbf-365"><a href="#optimize_local_rbf-365"><span class="linenos">365</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Cores number for parallel computing is set too high for this computer. &#39;</span> <span class="o">+</span>
</span><span id="optimize_local_rbf-366"><a href="#optimize_local_rbf-366"><span class="linenos">366</span></a>                        <span class="s1">&#39;Reset to &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cores</span><span class="p">))</span>
</span><span id="optimize_local_rbf-367"><a href="#optimize_local_rbf-367"><span class="linenos">367</span></a>
</span><span id="optimize_local_rbf-368"><a href="#optimize_local_rbf-368"><span class="linenos">368</span></a>    <span class="c1"># extract bounds and parameter names</span>
</span><span id="optimize_local_rbf-369"><a href="#optimize_local_rbf-369"><span class="linenos">369</span></a>
</span><span id="optimize_local_rbf-370"><a href="#optimize_local_rbf-370"><span class="linenos">370</span></a>    <span class="n">n_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params_subset</span><span class="p">)</span>
</span><span id="optimize_local_rbf-371"><a href="#optimize_local_rbf-371"><span class="linenos">371</span></a>    <span class="n">param_names</span> <span class="o">=</span> <span class="n">params_subset</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="optimize_local_rbf-372"><a href="#optimize_local_rbf-372"><span class="linenos">372</span></a>
</span><span id="optimize_local_rbf-373"><a href="#optimize_local_rbf-373"><span class="linenos">373</span></a>    <span class="n">lb</span> <span class="o">=</span> <span class="n">params_subset</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="optimize_local_rbf-374"><a href="#optimize_local_rbf-374"><span class="linenos">374</span></a>    <span class="n">ub</span> <span class="o">=</span> <span class="n">params_subset</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="optimize_local_rbf-375"><a href="#optimize_local_rbf-375"><span class="linenos">375</span></a>
</span><span id="optimize_local_rbf-376"><a href="#optimize_local_rbf-376"><span class="linenos">376</span></a>    <span class="c1"># generate initial points around model&#39;s current parameters</span>
</span><span id="optimize_local_rbf-377"><a href="#optimize_local_rbf-377"><span class="linenos">377</span></a>
</span><span id="optimize_local_rbf-378"><a href="#optimize_local_rbf-378"><span class="linenos">378</span></a>    <span class="k">def</span> <span class="nf">generate_initial_points</span><span class="p">(</span><span class="n">n_points</span><span class="p">):</span>
</span><span id="optimize_local_rbf-379"><a href="#optimize_local_rbf-379"><span class="linenos">379</span></a>
</span><span id="optimize_local_rbf-380"><a href="#optimize_local_rbf-380"><span class="linenos">380</span></a>        <span class="n">std_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">ub</span> <span class="o">-</span> <span class="n">lb</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.05</span>
</span><span id="optimize_local_rbf-381"><a href="#optimize_local_rbf-381"><span class="linenos">381</span></a>
</span><span id="optimize_local_rbf-382"><a href="#optimize_local_rbf-382"><span class="linenos">382</span></a>        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">start_values</span><span class="p">,</span> <span class="p">(</span><span class="n">n_points</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="optimize_local_rbf-383"><a href="#optimize_local_rbf-383"><span class="linenos">383</span></a>        <span class="n">points</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">std_dev</span><span class="p">,</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="optimize_local_rbf-384"><a href="#optimize_local_rbf-384"><span class="linenos">384</span></a>        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">)</span>
</span><span id="optimize_local_rbf-385"><a href="#optimize_local_rbf-385"><span class="linenos">385</span></a>
</span><span id="optimize_local_rbf-386"><a href="#optimize_local_rbf-386"><span class="linenos">386</span></a>        <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_values</span>
</span><span id="optimize_local_rbf-387"><a href="#optimize_local_rbf-387"><span class="linenos">387</span></a>
</span><span id="optimize_local_rbf-388"><a href="#optimize_local_rbf-388"><span class="linenos">388</span></a>        <span class="k">return</span> <span class="n">points</span>
</span><span id="optimize_local_rbf-389"><a href="#optimize_local_rbf-389"><span class="linenos">389</span></a>
</span><span id="optimize_local_rbf-390"><a href="#optimize_local_rbf-390"><span class="linenos">390</span></a>    <span class="c1"># objective function wrapper</span>
</span><span id="optimize_local_rbf-391"><a href="#optimize_local_rbf-391"><span class="linenos">391</span></a>
</span><span id="optimize_local_rbf-392"><a href="#optimize_local_rbf-392"><span class="linenos">392</span></a>    <span class="n">model_iter</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="optimize_local_rbf-393"><a href="#optimize_local_rbf-393"><span class="linenos">393</span></a>    <span class="n">model_iter</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">transform_lhs_fn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="optimize_local_rbf-394"><a href="#optimize_local_rbf-394"><span class="linenos">394</span></a>
</span><span id="optimize_local_rbf-395"><a href="#optimize_local_rbf-395"><span class="linenos">395</span></a>    <span class="n">objective_fun</span> <span class="o">=</span> <span class="n">ObjectiveFunction</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">ds</span><span class="p">,</span>
</span><span id="optimize_local_rbf-396"><a href="#optimize_local_rbf-396"><span class="linenos">396</span></a>                                      <span class="n">model</span><span class="o">=</span><span class="n">model_iter</span><span class="p">,</span>
</span><span id="optimize_local_rbf-397"><a href="#optimize_local_rbf-397"><span class="linenos">397</span></a>                                      <span class="n">revert_score_sign</span><span class="o">=</span><span class="n">revert_score_sign</span><span class="p">,</span>
</span><span id="optimize_local_rbf-398"><a href="#optimize_local_rbf-398"><span class="linenos">398</span></a>                                      <span class="n">error_score</span><span class="o">=</span><span class="n">error_score</span><span class="p">,</span>
</span><span id="optimize_local_rbf-399"><a href="#optimize_local_rbf-399"><span class="linenos">399</span></a>                                      <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="optimize_local_rbf-400"><a href="#optimize_local_rbf-400"><span class="linenos">400</span></a>
</span><span id="optimize_local_rbf-401"><a href="#optimize_local_rbf-401"><span class="linenos">401</span></a>    <span class="c1"># parallel evaluation function</span>
</span><span id="optimize_local_rbf-402"><a href="#optimize_local_rbf-402"><span class="linenos">402</span></a>
</span><span id="optimize_local_rbf-403"><a href="#optimize_local_rbf-403"><span class="linenos">403</span></a>    <span class="k">def</span> <span class="nf">evaluate_points</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
</span><span id="optimize_local_rbf-404"><a href="#optimize_local_rbf-404"><span class="linenos">404</span></a>        <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
</span><span id="optimize_local_rbf-405"><a href="#optimize_local_rbf-405"><span class="linenos">405</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">objective_fun</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
</span><span id="optimize_local_rbf-406"><a href="#optimize_local_rbf-406"><span class="linenos">406</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span id="optimize_local_rbf-407"><a href="#optimize_local_rbf-407"><span class="linenos">407</span></a>
</span><span id="optimize_local_rbf-408"><a href="#optimize_local_rbf-408"><span class="linenos">408</span></a>    <span class="c1"># initialize surrogate model</span>
</span><span id="optimize_local_rbf-409"><a href="#optimize_local_rbf-409"><span class="linenos">409</span></a>
</span><span id="optimize_local_rbf-410"><a href="#optimize_local_rbf-410"><span class="linenos">410</span></a>    <span class="n">n_start</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n_params</span><span class="p">,</span> <span class="n">iters_epoch</span><span class="p">)</span>
</span><span id="optimize_local_rbf-411"><a href="#optimize_local_rbf-411"><span class="linenos">411</span></a>    <span class="n">param_train</span> <span class="o">=</span> <span class="n">generate_initial_points</span><span class="p">(</span><span class="n">n_start</span><span class="p">)</span>
</span><span id="optimize_local_rbf-412"><a href="#optimize_local_rbf-412"><span class="linenos">412</span></a>    <span class="n">score_train</span> <span class="o">=</span> <span class="n">evaluate_points</span><span class="p">(</span><span class="n">param_train</span><span class="p">)</span>
</span><span id="optimize_local_rbf-413"><a href="#optimize_local_rbf-413"><span class="linenos">413</span></a>
</span><span id="optimize_local_rbf-414"><a href="#optimize_local_rbf-414"><span class="linenos">414</span></a>    <span class="n">sm</span> <span class="o">=</span> <span class="n">RBF</span><span class="p">(</span><span class="n">d0</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n_params</span>   <span class="c1"># d0 controls basis function width</span>
</span><span id="optimize_local_rbf-415"><a href="#optimize_local_rbf-415"><span class="linenos">415</span></a>             <span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="mf">1e-6</span>
</span><span id="optimize_local_rbf-416"><a href="#optimize_local_rbf-416"><span class="linenos">416</span></a>             <span class="p">,</span> <span class="n">print_global</span><span class="o">=</span><span class="kc">False</span>
</span><span id="optimize_local_rbf-417"><a href="#optimize_local_rbf-417"><span class="linenos">417</span></a>             <span class="p">,</span> <span class="n">print_training</span><span class="o">=</span><span class="kc">False</span>
</span><span id="optimize_local_rbf-418"><a href="#optimize_local_rbf-418"><span class="linenos">418</span></a>             <span class="p">,</span> <span class="n">print_prediction</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="optimize_local_rbf-419"><a href="#optimize_local_rbf-419"><span class="linenos">419</span></a>    <span class="n">sm</span><span class="o">.</span><span class="n">set_training_values</span><span class="p">(</span><span class="n">param_train</span><span class="p">,</span> <span class="n">score_train</span><span class="p">)</span>
</span><span id="optimize_local_rbf-420"><a href="#optimize_local_rbf-420"><span class="linenos">420</span></a>    <span class="n">sm</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="optimize_local_rbf-421"><a href="#optimize_local_rbf-421"><span class="linenos">421</span></a>
</span><span id="optimize_local_rbf-422"><a href="#optimize_local_rbf-422"><span class="linenos">422</span></a>    <span class="c1"># main loop over epochs</span>
</span><span id="optimize_local_rbf-423"><a href="#optimize_local_rbf-423"><span class="linenos">423</span></a>
</span><span id="optimize_local_rbf-424"><a href="#optimize_local_rbf-424"><span class="linenos">424</span></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
</span><span id="optimize_local_rbf-425"><a href="#optimize_local_rbf-425"><span class="linenos">425</span></a>        <span class="n">if_error</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="optimize_local_rbf-426"><a href="#optimize_local_rbf-426"><span class="linenos">426</span></a>
</span><span id="optimize_local_rbf-427"><a href="#optimize_local_rbf-427"><span class="linenos">427</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="optimize_local_rbf-428"><a href="#optimize_local_rbf-428"><span class="linenos">428</span></a>
</span><span id="optimize_local_rbf-429"><a href="#optimize_local_rbf-429"><span class="linenos">429</span></a>            <span class="c1"># batch acquisition via multi-start optimization</span>
</span><span id="optimize_local_rbf-430"><a href="#optimize_local_rbf-430"><span class="linenos">430</span></a>            <span class="n">batch_points</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="optimize_local_rbf-431"><a href="#optimize_local_rbf-431"><span class="linenos">431</span></a>
</span><span id="optimize_local_rbf-432"><a href="#optimize_local_rbf-432"><span class="linenos">432</span></a>            <span class="n">optimize_surrogate</span> <span class="o">=</span> <span class="n">ObjectiveRBF</span><span class="p">(</span><span class="n">param_train</span><span class="o">=</span><span class="n">param_train</span>
</span><span id="optimize_local_rbf-433"><a href="#optimize_local_rbf-433"><span class="linenos">433</span></a>                                              <span class="p">,</span> <span class="n">score_train</span><span class="o">=</span><span class="n">score_train</span>
</span><span id="optimize_local_rbf-434"><a href="#optimize_local_rbf-434"><span class="linenos">434</span></a>                                              <span class="p">,</span> <span class="n">ub</span><span class="o">=</span><span class="n">ub</span>
</span><span id="optimize_local_rbf-435"><a href="#optimize_local_rbf-435"><span class="linenos">435</span></a>                                              <span class="p">,</span> <span class="n">lb</span><span class="o">=</span><span class="n">lb</span>
</span><span id="optimize_local_rbf-436"><a href="#optimize_local_rbf-436"><span class="linenos">436</span></a>                                              <span class="p">,</span> <span class="n">iters_epoch</span><span class="o">=</span><span class="n">iters_epoch</span>
</span><span id="optimize_local_rbf-437"><a href="#optimize_local_rbf-437"><span class="linenos">437</span></a>                                              <span class="p">,</span> <span class="n">ftol_abs</span><span class="o">=</span><span class="n">ftol_abs</span>
</span><span id="optimize_local_rbf-438"><a href="#optimize_local_rbf-438"><span class="linenos">438</span></a>                                              <span class="p">,</span> <span class="n">sm_object</span><span class="o">=</span><span class="n">sm</span><span class="p">)</span>
</span><span id="optimize_local_rbf-439"><a href="#optimize_local_rbf-439"><span class="linenos">439</span></a>
</span><span id="optimize_local_rbf-440"><a href="#optimize_local_rbf-440"><span class="linenos">440</span></a>            <span class="c1"># parallel batch point generation</span>
</span><span id="optimize_local_rbf-441"><a href="#optimize_local_rbf-441"><span class="linenos">441</span></a>
</span><span id="optimize_local_rbf-442"><a href="#optimize_local_rbf-442"><span class="linenos">442</span></a>            <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">cores</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
</span><span id="optimize_local_rbf-443"><a href="#optimize_local_rbf-443"><span class="linenos">443</span></a>                <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">optimize_surrogate</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cores</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)]</span>
</span><span id="optimize_local_rbf-444"><a href="#optimize_local_rbf-444"><span class="linenos">444</span></a>                <span class="n">batch_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">]</span>
</span><span id="optimize_local_rbf-445"><a href="#optimize_local_rbf-445"><span class="linenos">445</span></a>
</span><span id="optimize_local_rbf-446"><a href="#optimize_local_rbf-446"><span class="linenos">446</span></a>            <span class="c1"># evaluate batch in parallel</span>
</span><span id="optimize_local_rbf-447"><a href="#optimize_local_rbf-447"><span class="linenos">447</span></a>
</span><span id="optimize_local_rbf-448"><a href="#optimize_local_rbf-448"><span class="linenos">448</span></a>            <span class="n">new_score</span> <span class="o">=</span> <span class="n">evaluate_points</span><span class="p">(</span><span class="n">batch_points</span><span class="p">)</span>
</span><span id="optimize_local_rbf-449"><a href="#optimize_local_rbf-449"><span class="linenos">449</span></a>
</span><span id="optimize_local_rbf-450"><a href="#optimize_local_rbf-450"><span class="linenos">450</span></a>            <span class="c1"># update training data</span>
</span><span id="optimize_local_rbf-451"><a href="#optimize_local_rbf-451"><span class="linenos">451</span></a>
</span><span id="optimize_local_rbf-452"><a href="#optimize_local_rbf-452"><span class="linenos">452</span></a>            <span class="n">param_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">param_train</span><span class="p">,</span> <span class="n">batch_points</span><span class="p">])</span>
</span><span id="optimize_local_rbf-453"><a href="#optimize_local_rbf-453"><span class="linenos">453</span></a>            <span class="n">score_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">score_train</span><span class="p">,</span> <span class="n">new_score</span><span class="p">])</span>
</span><span id="optimize_local_rbf-454"><a href="#optimize_local_rbf-454"><span class="linenos">454</span></a>            <span class="n">sm</span><span class="o">.</span><span class="n">set_training_values</span><span class="p">(</span><span class="n">param_train</span><span class="p">,</span> <span class="n">score_train</span><span class="p">)</span>
</span><span id="optimize_local_rbf-455"><a href="#optimize_local_rbf-455"><span class="linenos">455</span></a>            <span class="n">sm</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="optimize_local_rbf-456"><a href="#optimize_local_rbf-456"><span class="linenos">456</span></a>
</span><span id="optimize_local_rbf-457"><a href="#optimize_local_rbf-457"><span class="linenos">457</span></a>            <span class="c1"># update model with best parameters</span>
</span><span id="optimize_local_rbf-458"><a href="#optimize_local_rbf-458"><span class="linenos">458</span></a>
</span><span id="optimize_local_rbf-459"><a href="#optimize_local_rbf-459"><span class="linenos">459</span></a>            <span class="n">best_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">score_train</span><span class="p">)</span>
</span><span id="optimize_local_rbf-460"><a href="#optimize_local_rbf-460"><span class="linenos">460</span></a>            <span class="n">best_params</span> <span class="o">=</span> <span class="n">param_train</span><span class="p">[</span><span class="n">best_idx</span><span class="p">]</span>
</span><span id="optimize_local_rbf-461"><a href="#optimize_local_rbf-461"><span class="linenos">461</span></a>            <span class="n">best_score</span> <span class="o">=</span> <span class="n">score_train</span><span class="p">[</span><span class="n">best_idx</span><span class="p">]</span>
</span><span id="optimize_local_rbf-462"><a href="#optimize_local_rbf-462"><span class="linenos">462</span></a>            <span class="n">model_iter</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">param_names</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_params</span>
</span><span id="optimize_local_rbf-463"><a href="#optimize_local_rbf-463"><span class="linenos">463</span></a>
</span><span id="optimize_local_rbf-464"><a href="#optimize_local_rbf-464"><span class="linenos">464</span></a>            <span class="c1"># logging</span>
</span><span id="optimize_local_rbf-465"><a href="#optimize_local_rbf-465"><span class="linenos">465</span></a>
</span><span id="optimize_local_rbf-466"><a href="#optimize_local_rbf-466"><span class="linenos">466</span></a>            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="optimize_local_rbf-467"><a href="#optimize_local_rbf-467"><span class="linenos">467</span></a>                <span class="n">score_print</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">best_score</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="optimize_local_rbf-468"><a href="#optimize_local_rbf-468"><span class="linenos">468</span></a>                               <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">best_score</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">500</span>
</span><span id="optimize_local_rbf-469"><a href="#optimize_local_rbf-469"><span class="linenos">469</span></a>                               <span class="k">else</span> <span class="nb">round</span><span class="p">(</span><span class="n">best_score</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="optimize_local_rbf-470"><a href="#optimize_local_rbf-470"><span class="linenos">470</span></a>                <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">timespec</span><span class="o">=</span><span class="s2">&quot;seconds&quot;</span><span class="p">)</span>
</span><span id="optimize_local_rbf-471"><a href="#optimize_local_rbf-471"><span class="linenos">471</span></a>
</span><span id="optimize_local_rbf-472"><a href="#optimize_local_rbf-472"><span class="linenos">472</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Combined scoring : &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">score_print</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;; epoch : &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="optimize_local_rbf-473"><a href="#optimize_local_rbf-473"><span class="linenos">473</span></a>                    <span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; : &#39;</span> <span class="o">+</span> <span class="n">timestamp</span><span class="p">)</span>
</span><span id="optimize_local_rbf-474"><a href="#optimize_local_rbf-474"><span class="linenos">474</span></a>
</span><span id="optimize_local_rbf-475"><a href="#optimize_local_rbf-475"><span class="linenos">475</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="optimize_local_rbf-476"><a href="#optimize_local_rbf-476"><span class="linenos">476</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoche terminated unsuccessfully&quot;</span><span class="p">)</span>
</span><span id="optimize_local_rbf-477"><a href="#optimize_local_rbf-477"><span class="linenos">477</span></a>            <span class="n">if_error</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="optimize_local_rbf-478"><a href="#optimize_local_rbf-478"><span class="linenos">478</span></a>
</span><span id="optimize_local_rbf-479"><a href="#optimize_local_rbf-479"><span class="linenos">479</span></a>        <span class="c1"># boundary enforcement</span>
</span><span id="optimize_local_rbf-480"><a href="#optimize_local_rbf-480"><span class="linenos">480</span></a>
</span><span id="optimize_local_rbf-481"><a href="#optimize_local_rbf-481"><span class="linenos">481</span></a>        <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span>\
</span><span id="optimize_local_rbf-482"><a href="#optimize_local_rbf-482"><span class="linenos">482</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]][</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span>
</span><span id="optimize_local_rbf-483"><a href="#optimize_local_rbf-483"><span class="linenos">483</span></a>        <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span>\
</span><span id="optimize_local_rbf-484"><a href="#optimize_local_rbf-484"><span class="linenos">484</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]][</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span>
</span><span id="optimize_local_rbf-485"><a href="#optimize_local_rbf-485"><span class="linenos">485</span></a>
</span><span id="optimize_local_rbf-486"><a href="#optimize_local_rbf-486"><span class="linenos">486</span></a>        <span class="k">if</span> <span class="n">if_error</span><span class="p">:</span>
</span><span id="optimize_local_rbf-487"><a href="#optimize_local_rbf-487"><span class="linenos">487</span></a>            <span class="k">break</span>
</span><span id="optimize_local_rbf-488"><a href="#optimize_local_rbf-488"><span class="linenos">488</span></a>
</span><span id="optimize_local_rbf-489"><a href="#optimize_local_rbf-489"><span class="linenos">489</span></a>    <span class="k">return</span> <span class="n">model_iter</span>
</span></pre></div>


            <div class="docstring"><p>Surrogate-model-based optimization with parallel evaluation.
Bayesian optimization using RBF surrogate model and Latin Hypercube Sampling.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>ds</strong>:  dataset</li>
<li><strong>model</strong>:  Model object</li>
<li><strong>revert_score_sign</strong>:  if the score is the bigger, the better; this algo minimizes score</li>
<li><strong>verbose</strong>:  print diagnostic or progress information</li>
<li><strong>epochs</strong>:  number of epochs</li>
<li><strong>iters_epoch</strong>:  number of objective function calculations per epoch</li>
<li><strong>error_score</strong>:  extremely big value to be used as score if fit_predict returns None (error)</li>
<li><strong>cores</strong>:  processor cores to be used in parallel computing</li>
<li><strong>ftol_abs: early stop threshold</strong>:  minimum absolute score gain per iteration, see description</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>tuned Model</p>
</blockquote>
</div>


                </section>
                <section id="optimize_local_ncma">
                            <input id="optimize_local_ncma-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">optimize_local_ncma</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">ds</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>,</span><span class="param">	<span class="n">model</span><span class="p">:</span> <span class="n"><a href="../model/model.html#Model">fermatrica.model.model.Model</a></span>,</span><span class="param">	<span class="n">revert_score_sign</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">iters_epoch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>,</span><span class="param">	<span class="n">error_score</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1000000000000.0</span>,</span><span class="param">	<span class="n">cores</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span>,</span><span class="param">	<span class="n">approach</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;init_sequent&#39;</span>,</span><span class="param">	<span class="n">save_epoch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="optimize_local_ncma-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#optimize_local_ncma"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="optimize_local_ncma-492"><a href="#optimize_local_ncma-492"><span class="linenos">492</span></a><span class="k">def</span> <span class="nf">optimize_local_ncma</span><span class="p">(</span><span class="n">ds</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
</span><span id="optimize_local_ncma-493"><a href="#optimize_local_ncma-493"><span class="linenos">493</span></a>                        <span class="n">model</span><span class="p">:</span> <span class="s2">&quot;Model&quot;</span><span class="p">,</span>
</span><span id="optimize_local_ncma-494"><a href="#optimize_local_ncma-494"><span class="linenos">494</span></a>                        <span class="n">revert_score_sign</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="optimize_local_ncma-495"><a href="#optimize_local_ncma-495"><span class="linenos">495</span></a>                        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="optimize_local_ncma-496"><a href="#optimize_local_ncma-496"><span class="linenos">496</span></a>                        <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="optimize_local_ncma-497"><a href="#optimize_local_ncma-497"><span class="linenos">497</span></a>                        <span class="n">iters_epoch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
</span><span id="optimize_local_ncma-498"><a href="#optimize_local_ncma-498"><span class="linenos">498</span></a>                        <span class="n">error_score</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e+12</span><span class="p">,</span>
</span><span id="optimize_local_ncma-499"><a href="#optimize_local_ncma-499"><span class="linenos">499</span></a>                        <span class="n">cores</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
</span><span id="optimize_local_ncma-500"><a href="#optimize_local_ncma-500"><span class="linenos">500</span></a>                        <span class="n">approach</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;init_sequent&#39;</span><span class="p">,</span>
</span><span id="optimize_local_ncma-501"><a href="#optimize_local_ncma-501"><span class="linenos">501</span></a>                        <span class="n">save_epoch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="optimize_local_ncma-502"><a href="#optimize_local_ncma-502"><span class="linenos">502</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="optimize_local_ncma-503"><a href="#optimize_local_ncma-503"><span class="linenos">503</span></a><span class="sd">    Wrapper for CMA-ES optimization algorithm using nevergrad library. CMA-ES is a derivative-free</span>
</span><span id="optimize_local_ncma-504"><a href="#optimize_local_ncma-504"><span class="linenos">504</span></a><span class="sd">    global optimizer that maintains search history between iterations. It can handle bounds</span>
</span><span id="optimize_local_ncma-505"><a href="#optimize_local_ncma-505"><span class="linenos">505</span></a><span class="sd">    and is robust to noisy objective functions.</span>
</span><span id="optimize_local_ncma-506"><a href="#optimize_local_ncma-506"><span class="linenos">506</span></a>
</span><span id="optimize_local_ncma-507"><a href="#optimize_local_ncma-507"><span class="linenos">507</span></a><span class="sd">    Early stop threshold is implemented via callback mechanism.</span>
</span><span id="optimize_local_ncma-508"><a href="#optimize_local_ncma-508"><span class="linenos">508</span></a>
</span><span id="optimize_local_ncma-509"><a href="#optimize_local_ncma-509"><span class="linenos">509</span></a><span class="sd">    :param ds: dataset</span>
</span><span id="optimize_local_ncma-510"><a href="#optimize_local_ncma-510"><span class="linenos">510</span></a><span class="sd">    :param model: Model object</span>
</span><span id="optimize_local_ncma-511"><a href="#optimize_local_ncma-511"><span class="linenos">511</span></a><span class="sd">    :param revert_score_sign: if the score is the bigger, the better; this algo minimizes score</span>
</span><span id="optimize_local_ncma-512"><a href="#optimize_local_ncma-512"><span class="linenos">512</span></a><span class="sd">    :param verbose: print diagnostic or progress information</span>
</span><span id="optimize_local_ncma-513"><a href="#optimize_local_ncma-513"><span class="linenos">513</span></a><span class="sd">    :param epochs: number of epochs; each epoch is independent and returns its own score and tuned params</span>
</span><span id="optimize_local_ncma-514"><a href="#optimize_local_ncma-514"><span class="linenos">514</span></a><span class="sd">    :param iters_epoch: number of iterations per epoch</span>
</span><span id="optimize_local_ncma-515"><a href="#optimize_local_ncma-515"><span class="linenos">515</span></a><span class="sd">    :param error_score: extremely bad value to be used as score if fit_predict returns None (error)</span>
</span><span id="optimize_local_ncma-516"><a href="#optimize_local_ncma-516"><span class="linenos">516</span></a><span class="sd">    :param cores: processor cores to be used in parallel computing</span>
</span><span id="optimize_local_ncma-517"><a href="#optimize_local_ncma-517"><span class="linenos">517</span></a><span class="sd">    :param approach: &#39;void&#39;, &#39;init&#39;, &#39;sequent&#39;, &#39;init_sequent&#39;</span>
</span><span id="optimize_local_ncma-518"><a href="#optimize_local_ncma-518"><span class="linenos">518</span></a><span class="sd">    :param save_epoch: if every epoch to be saved or path to the folder to save tuned models</span>
</span><span id="optimize_local_ncma-519"><a href="#optimize_local_ncma-519"><span class="linenos">519</span></a><span class="sd">    :return: tuned Model of the last epoch</span>
</span><span id="optimize_local_ncma-520"><a href="#optimize_local_ncma-520"><span class="linenos">520</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="optimize_local_ncma-521"><a href="#optimize_local_ncma-521"><span class="linenos">521</span></a>
</span><span id="optimize_local_ncma-522"><a href="#optimize_local_ncma-522"><span class="linenos">522</span></a>    <span class="n">params_subset</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="optimize_local_ncma-523"><a href="#optimize_local_ncma-523"><span class="linenos">523</span></a>
</span><span id="optimize_local_ncma-524"><a href="#optimize_local_ncma-524"><span class="linenos">524</span></a>    <span class="k">if</span> <span class="n">params_subset</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="optimize_local_ncma-525"><a href="#optimize_local_ncma-525"><span class="linenos">525</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No active non-fixed parameters to optimize&quot;</span><span class="p">)</span>
</span><span id="optimize_local_ncma-526"><a href="#optimize_local_ncma-526"><span class="linenos">526</span></a>        <span class="k">return</span> <span class="n">model</span>
</span><span id="optimize_local_ncma-527"><a href="#optimize_local_ncma-527"><span class="linenos">527</span></a>
</span><span id="optimize_local_ncma-528"><a href="#optimize_local_ncma-528"><span class="linenos">528</span></a>    <span class="c1"># set up multiprocessing</span>
</span><span id="optimize_local_ncma-529"><a href="#optimize_local_ncma-529"><span class="linenos">529</span></a>
</span><span id="optimize_local_ncma-530"><a href="#optimize_local_ncma-530"><span class="linenos">530</span></a>    <span class="k">if</span> <span class="n">cores</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="optimize_local_ncma-531"><a href="#optimize_local_ncma-531"><span class="linenos">531</span></a>        <span class="n">cores</span> <span class="o">=</span> <span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="optimize_local_ncma-532"><a href="#optimize_local_ncma-532"><span class="linenos">532</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Cores number for parallel computing is set too high for this computer. &#39;</span>
</span><span id="optimize_local_ncma-533"><a href="#optimize_local_ncma-533"><span class="linenos">533</span></a>                        <span class="sa">f</span><span class="s1">&#39;Reset to </span><span class="si">{</span><span class="n">cores</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="optimize_local_ncma-534"><a href="#optimize_local_ncma-534"><span class="linenos">534</span></a>
</span><span id="optimize_local_ncma-535"><a href="#optimize_local_ncma-535"><span class="linenos">535</span></a>    <span class="c1"># get parameter bounds</span>
</span><span id="optimize_local_ncma-536"><a href="#optimize_local_ncma-536"><span class="linenos">536</span></a>
</span><span id="optimize_local_ncma-537"><a href="#optimize_local_ncma-537"><span class="linenos">537</span></a>    <span class="n">lwr</span> <span class="o">=</span> <span class="n">params_subset</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="optimize_local_ncma-538"><a href="#optimize_local_ncma-538"><span class="linenos">538</span></a>    <span class="n">upr</span> <span class="o">=</span> <span class="n">params_subset</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="optimize_local_ncma-539"><a href="#optimize_local_ncma-539"><span class="linenos">539</span></a>
</span><span id="optimize_local_ncma-540"><a href="#optimize_local_ncma-540"><span class="linenos">540</span></a>    <span class="n">lwr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">lwr</span><span class="p">,</span> <span class="n">nan</span><span class="o">=-</span><span class="mf">1e+8</span><span class="p">)</span>
</span><span id="optimize_local_ncma-541"><a href="#optimize_local_ncma-541"><span class="linenos">541</span></a>    <span class="n">upr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">upr</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">1e+8</span><span class="p">)</span>
</span><span id="optimize_local_ncma-542"><a href="#optimize_local_ncma-542"><span class="linenos">542</span></a>
</span><span id="optimize_local_ncma-543"><a href="#optimize_local_ncma-543"><span class="linenos">543</span></a>    <span class="c1"># create new objective function instance for each epoch</span>
</span><span id="optimize_local_ncma-544"><a href="#optimize_local_ncma-544"><span class="linenos">544</span></a>
</span><span id="optimize_local_ncma-545"><a href="#optimize_local_ncma-545"><span class="linenos">545</span></a>    <span class="n">model_iter</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="optimize_local_ncma-546"><a href="#optimize_local_ncma-546"><span class="linenos">546</span></a>    <span class="n">model_iter</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">transform_lhs_fn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="optimize_local_ncma-547"><a href="#optimize_local_ncma-547"><span class="linenos">547</span></a>
</span><span id="optimize_local_ncma-548"><a href="#optimize_local_ncma-548"><span class="linenos">548</span></a>    <span class="n">objective_fun</span> <span class="o">=</span> <span class="n">ObjectiveFunction</span><span class="p">(</span>
</span><span id="optimize_local_ncma-549"><a href="#optimize_local_ncma-549"><span class="linenos">549</span></a>        <span class="n">ds</span><span class="o">=</span><span class="n">ds</span><span class="p">,</span>
</span><span id="optimize_local_ncma-550"><a href="#optimize_local_ncma-550"><span class="linenos">550</span></a>        <span class="n">model</span><span class="o">=</span><span class="n">model_iter</span><span class="p">,</span>
</span><span id="optimize_local_ncma-551"><a href="#optimize_local_ncma-551"><span class="linenos">551</span></a>        <span class="n">revert_score_sign</span><span class="o">=</span><span class="n">revert_score_sign</span><span class="p">,</span>
</span><span id="optimize_local_ncma-552"><a href="#optimize_local_ncma-552"><span class="linenos">552</span></a>        <span class="n">error_score</span><span class="o">=</span><span class="n">error_score</span><span class="p">,</span>
</span><span id="optimize_local_ncma-553"><a href="#optimize_local_ncma-553"><span class="linenos">553</span></a>        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
</span><span id="optimize_local_ncma-554"><a href="#optimize_local_ncma-554"><span class="linenos">554</span></a>    <span class="p">)</span>
</span><span id="optimize_local_ncma-555"><a href="#optimize_local_ncma-555"><span class="linenos">555</span></a>
</span><span id="optimize_local_ncma-556"><a href="#optimize_local_ncma-556"><span class="linenos">556</span></a>    <span class="c1"># get start values</span>
</span><span id="optimize_local_ncma-557"><a href="#optimize_local_ncma-557"><span class="linenos">557</span></a>
</span><span id="optimize_local_ncma-558"><a href="#optimize_local_ncma-558"><span class="linenos">558</span></a>    <span class="n">start_values</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">params_subset</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="optimize_local_ncma-559"><a href="#optimize_local_ncma-559"><span class="linenos">559</span></a>    <span class="n">param_names</span> <span class="o">=</span> <span class="n">params_subset</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="optimize_local_ncma-560"><a href="#optimize_local_ncma-560"><span class="linenos">560</span></a>
</span><span id="optimize_local_ncma-561"><a href="#optimize_local_ncma-561"><span class="linenos">561</span></a>    <span class="n">best_score</span> <span class="o">=</span> <span class="n">objective_fun</span><span class="p">(</span><span class="n">params_cur</span><span class="o">=</span><span class="n">start_values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
</span><span id="optimize_local_ncma-562"><a href="#optimize_local_ncma-562"><span class="linenos">562</span></a>
</span><span id="optimize_local_ncma-563"><a href="#optimize_local_ncma-563"><span class="linenos">563</span></a>    <span class="c1"># main epoch loop</span>
</span><span id="optimize_local_ncma-564"><a href="#optimize_local_ncma-564"><span class="linenos">564</span></a>
</span><span id="optimize_local_ncma-565"><a href="#optimize_local_ncma-565"><span class="linenos">565</span></a>    <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">cores</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
</span><span id="optimize_local_ncma-566"><a href="#optimize_local_ncma-566"><span class="linenos">566</span></a>
</span><span id="optimize_local_ncma-567"><a href="#optimize_local_ncma-567"><span class="linenos">567</span></a>        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
</span><span id="optimize_local_ncma-568"><a href="#optimize_local_ncma-568"><span class="linenos">568</span></a>
</span><span id="optimize_local_ncma-569"><a href="#optimize_local_ncma-569"><span class="linenos">569</span></a>            <span class="c1"># set up search space</span>
</span><span id="optimize_local_ncma-570"><a href="#optimize_local_ncma-570"><span class="linenos">570</span></a>
</span><span id="optimize_local_ncma-571"><a href="#optimize_local_ncma-571"><span class="linenos">571</span></a>            <span class="k">if</span> <span class="n">approach</span> <span class="o">==</span> <span class="s1">&#39;void&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">approach</span> <span class="o">==</span> <span class="s1">&#39;sequent&#39;</span> <span class="ow">and</span> <span class="n">epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="optimize_local_ncma-572"><a href="#optimize_local_ncma-572"><span class="linenos">572</span></a>                <span class="n">start_values_cur</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">bound</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bound</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">bound</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lwr</span><span class="p">,</span> <span class="n">upr</span><span class="p">)]</span>
</span><span id="optimize_local_ncma-573"><a href="#optimize_local_ncma-573"><span class="linenos">573</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="optimize_local_ncma-574"><a href="#optimize_local_ncma-574"><span class="linenos">574</span></a>                <span class="n">start_values_cur</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">start_values</span><span class="p">)</span>
</span><span id="optimize_local_ncma-575"><a href="#optimize_local_ncma-575"><span class="linenos">575</span></a>
</span><span id="optimize_local_ncma-576"><a href="#optimize_local_ncma-576"><span class="linenos">576</span></a>            <span class="n">search_space</span> <span class="o">=</span> <span class="n">ng</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">Instrumentation</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
</span><span id="optimize_local_ncma-577"><a href="#optimize_local_ncma-577"><span class="linenos">577</span></a>                <span class="n">name</span><span class="p">:</span> <span class="n">ng</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">Scalar</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">high</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">val</span><span class="p">)</span>
</span><span id="optimize_local_ncma-578"><a href="#optimize_local_ncma-578"><span class="linenos">578</span></a>                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="n">lwr</span><span class="p">,</span> <span class="n">upr</span><span class="p">,</span> <span class="n">start_values_cur</span><span class="p">)</span>
</span><span id="optimize_local_ncma-579"><a href="#optimize_local_ncma-579"><span class="linenos">579</span></a>            <span class="p">})</span>
</span><span id="optimize_local_ncma-580"><a href="#optimize_local_ncma-580"><span class="linenos">580</span></a>
</span><span id="optimize_local_ncma-581"><a href="#optimize_local_ncma-581"><span class="linenos">581</span></a>            <span class="n">objective_ng</span> <span class="o">=</span> <span class="n">ObjectiveNG</span><span class="p">(</span><span class="n">param_names</span><span class="o">=</span><span class="n">param_names</span><span class="p">,</span> <span class="n">objective_fun</span><span class="o">=</span><span class="n">objective_fun</span><span class="p">)</span>
</span><span id="optimize_local_ncma-582"><a href="#optimize_local_ncma-582"><span class="linenos">582</span></a>
</span><span id="optimize_local_ncma-583"><a href="#optimize_local_ncma-583"><span class="linenos">583</span></a>            <span class="c1"># initialize CMA-ES</span>
</span><span id="optimize_local_ncma-584"><a href="#optimize_local_ncma-584"><span class="linenos">584</span></a>
</span><span id="optimize_local_ncma-585"><a href="#optimize_local_ncma-585"><span class="linenos">585</span></a>            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">ng</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">CMA</span><span class="p">(</span>
</span><span id="optimize_local_ncma-586"><a href="#optimize_local_ncma-586"><span class="linenos">586</span></a>                <span class="n">parametrization</span><span class="o">=</span><span class="n">search_space</span><span class="p">,</span>
</span><span id="optimize_local_ncma-587"><a href="#optimize_local_ncma-587"><span class="linenos">587</span></a>                <span class="n">budget</span><span class="o">=</span><span class="n">iters_epoch</span><span class="p">,</span>
</span><span id="optimize_local_ncma-588"><a href="#optimize_local_ncma-588"><span class="linenos">588</span></a>                <span class="n">num_workers</span><span class="o">=</span><span class="n">cores</span><span class="p">,</span>
</span><span id="optimize_local_ncma-589"><a href="#optimize_local_ncma-589"><span class="linenos">589</span></a>            <span class="p">)</span>
</span><span id="optimize_local_ncma-590"><a href="#optimize_local_ncma-590"><span class="linenos">590</span></a>
</span><span id="optimize_local_ncma-591"><a href="#optimize_local_ncma-591"><span class="linenos">591</span></a>            <span class="c1"># callbacks</span>
</span><span id="optimize_local_ncma-592"><a href="#optimize_local_ncma-592"><span class="linenos">592</span></a>
</span><span id="optimize_local_ncma-593"><a href="#optimize_local_ncma-593"><span class="linenos">593</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="optimize_local_ncma-594"><a href="#optimize_local_ncma-594"><span class="linenos">594</span></a>                <span class="n">verbose_cb</span> <span class="o">=</span> <span class="n">VerboseNG</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="optimize_local_ncma-595"><a href="#optimize_local_ncma-595"><span class="linenos">595</span></a>                <span class="n">optimizer</span><span class="o">.</span><span class="n">register_callback</span><span class="p">(</span><span class="s1">&#39;tell&#39;</span><span class="p">,</span> <span class="n">verbose_cb</span><span class="p">)</span>
</span><span id="optimize_local_ncma-596"><a href="#optimize_local_ncma-596"><span class="linenos">596</span></a>
</span><span id="optimize_local_ncma-597"><a href="#optimize_local_ncma-597"><span class="linenos">597</span></a>            <span class="c1"># run optimization</span>
</span><span id="optimize_local_ncma-598"><a href="#optimize_local_ncma-598"><span class="linenos">598</span></a>
</span><span id="optimize_local_ncma-599"><a href="#optimize_local_ncma-599"><span class="linenos">599</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="optimize_local_ncma-600"><a href="#optimize_local_ncma-600"><span class="linenos">600</span></a>                <span class="n">rtrn</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">objective_ng</span>
</span><span id="optimize_local_ncma-601"><a href="#optimize_local_ncma-601"><span class="linenos">601</span></a>                                          <span class="p">,</span> <span class="n">executor</span><span class="o">=</span><span class="n">executor</span>
</span><span id="optimize_local_ncma-602"><a href="#optimize_local_ncma-602"><span class="linenos">602</span></a>                                          <span class="c1"># , batch_mode=True</span>
</span><span id="optimize_local_ncma-603"><a href="#optimize_local_ncma-603"><span class="linenos">603</span></a>                                          <span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="optimize_local_ncma-604"><a href="#optimize_local_ncma-604"><span class="linenos">604</span></a>                <span class="n">best_params</span> <span class="o">=</span> <span class="n">rtrn</span><span class="o">.</span><span class="n">value</span>
</span><span id="optimize_local_ncma-605"><a href="#optimize_local_ncma-605"><span class="linenos">605</span></a>
</span><span id="optimize_local_ncma-606"><a href="#optimize_local_ncma-606"><span class="linenos">606</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="optimize_local_ncma-607"><a href="#optimize_local_ncma-607"><span class="linenos">607</span></a>                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Epoche did not terminate successfully&quot;</span><span class="p">)</span>
</span><span id="optimize_local_ncma-608"><a href="#optimize_local_ncma-608"><span class="linenos">608</span></a>                <span class="n">best_params</span> <span class="o">=</span> <span class="n">start_values</span>
</span><span id="optimize_local_ncma-609"><a href="#optimize_local_ncma-609"><span class="linenos">609</span></a>
</span><span id="optimize_local_ncma-610"><a href="#optimize_local_ncma-610"><span class="linenos">610</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Epoche &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; finished&#39;</span><span class="p">)</span>
</span><span id="optimize_local_ncma-611"><a href="#optimize_local_ncma-611"><span class="linenos">611</span></a>
</span><span id="optimize_local_ncma-612"><a href="#optimize_local_ncma-612"><span class="linenos">612</span></a>            <span class="c1"># update model with the best parameters</span>
</span><span id="optimize_local_ncma-613"><a href="#optimize_local_ncma-613"><span class="linenos">613</span></a>
</span><span id="optimize_local_ncma-614"><a href="#optimize_local_ncma-614"><span class="linenos">614</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">best_params</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
</span><span id="optimize_local_ncma-615"><a href="#optimize_local_ncma-615"><span class="linenos">615</span></a>                <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="optimize_local_ncma-616"><a href="#optimize_local_ncma-616"><span class="linenos">616</span></a>                <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">:</span>
</span><span id="optimize_local_ncma-617"><a href="#optimize_local_ncma-617"><span class="linenos">617</span></a>                    <span class="n">param_value</span> <span class="o">=</span> <span class="n">best_params</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">par</span><span class="p">]</span>
</span><span id="optimize_local_ncma-618"><a href="#optimize_local_ncma-618"><span class="linenos">618</span></a>                    <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param_value</span><span class="p">)</span>
</span><span id="optimize_local_ncma-619"><a href="#optimize_local_ncma-619"><span class="linenos">619</span></a>
</span><span id="optimize_local_ncma-620"><a href="#optimize_local_ncma-620"><span class="linenos">620</span></a>                <span class="n">score_cur</span> <span class="o">=</span> <span class="n">objective_fun</span><span class="p">(</span><span class="n">params_cur</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span><span id="optimize_local_ncma-621"><a href="#optimize_local_ncma-621"><span class="linenos">621</span></a>
</span><span id="optimize_local_ncma-622"><a href="#optimize_local_ncma-622"><span class="linenos">622</span></a>                <span class="k">if</span> <span class="n">approach</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;init_sequent&#39;</span><span class="p">,</span> <span class="s1">&#39;sequent&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">score_cur</span> <span class="o">&lt;</span> <span class="n">best_score</span><span class="p">:</span>
</span><span id="optimize_local_ncma-623"><a href="#optimize_local_ncma-623"><span class="linenos">623</span></a>                    <span class="n">start_values</span> <span class="o">=</span> <span class="n">params</span>
</span><span id="optimize_local_ncma-624"><a href="#optimize_local_ncma-624"><span class="linenos">624</span></a>                    <span class="n">best_score</span> <span class="o">=</span> <span class="n">score_cur</span>
</span><span id="optimize_local_ncma-625"><a href="#optimize_local_ncma-625"><span class="linenos">625</span></a>                <span class="k">elif</span> <span class="n">approach</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;init_sequent&#39;</span><span class="p">,</span> <span class="s1">&#39;sequent&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">score_cur</span> <span class="o">&gt;=</span> <span class="n">best_score</span><span class="p">:</span>
</span><span id="optimize_local_ncma-626"><a href="#optimize_local_ncma-626"><span class="linenos">626</span></a>                    <span class="n">params</span> <span class="o">=</span> <span class="n">start_values</span>
</span><span id="optimize_local_ncma-627"><a href="#optimize_local_ncma-627"><span class="linenos">627</span></a>                <span class="n">model_iter</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">params_subset</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span>
</span><span id="optimize_local_ncma-628"><a href="#optimize_local_ncma-628"><span class="linenos">628</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="optimize_local_ncma-629"><a href="#optimize_local_ncma-629"><span class="linenos">629</span></a>                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Epoche did not terminate successfully&quot;</span><span class="p">)</span>
</span><span id="optimize_local_ncma-630"><a href="#optimize_local_ncma-630"><span class="linenos">630</span></a>
</span><span id="optimize_local_ncma-631"><a href="#optimize_local_ncma-631"><span class="linenos">631</span></a>            <span class="c1"># clip parameters to bounds</span>
</span><span id="optimize_local_ncma-632"><a href="#optimize_local_ncma-632"><span class="linenos">632</span></a>
</span><span id="optimize_local_ncma-633"><a href="#optimize_local_ncma-633"><span class="linenos">633</span></a>            <span class="n">optim_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">model_iter</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model_iter</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="optimize_local_ncma-634"><a href="#optimize_local_ncma-634"><span class="linenos">634</span></a>            <span class="n">upper_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">model_iter</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">model_iter</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">optim_mask</span>
</span><span id="optimize_local_ncma-635"><a href="#optimize_local_ncma-635"><span class="linenos">635</span></a>            <span class="n">model_iter</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">upper_mask</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_iter</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">upper_mask</span><span class="p">,</span> <span class="s1">&#39;upper&#39;</span><span class="p">]</span>
</span><span id="optimize_local_ncma-636"><a href="#optimize_local_ncma-636"><span class="linenos">636</span></a>            <span class="n">lower_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">model_iter</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">model_iter</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">optim_mask</span>
</span><span id="optimize_local_ncma-637"><a href="#optimize_local_ncma-637"><span class="linenos">637</span></a>            <span class="n">model_iter</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lower_mask</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_iter</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lower_mask</span><span class="p">,</span> <span class="s1">&#39;lower&#39;</span><span class="p">]</span>
</span><span id="optimize_local_ncma-638"><a href="#optimize_local_ncma-638"><span class="linenos">638</span></a>
</span><span id="optimize_local_ncma-639"><a href="#optimize_local_ncma-639"><span class="linenos">639</span></a>            <span class="c1"># save model if required</span>
</span><span id="optimize_local_ncma-640"><a href="#optimize_local_ncma-640"><span class="linenos">640</span></a>
</span><span id="optimize_local_ncma-641"><a href="#optimize_local_ncma-641"><span class="linenos">641</span></a>            <span class="k">if</span> <span class="n">save_epoch</span><span class="p">:</span>
</span><span id="optimize_local_ncma-642"><a href="#optimize_local_ncma-642"><span class="linenos">642</span></a>                <span class="n">_save_model</span><span class="p">(</span><span class="n">model_iter</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">save_epoch</span><span class="p">)</span>
</span><span id="optimize_local_ncma-643"><a href="#optimize_local_ncma-643"><span class="linenos">643</span></a>
</span><span id="optimize_local_ncma-644"><a href="#optimize_local_ncma-644"><span class="linenos">644</span></a>    <span class="k">return</span> <span class="n">model_iter</span>
</span></pre></div>


            <div class="docstring"><p>Wrapper for CMA-ES optimization algorithm using nevergrad library. CMA-ES is a derivative-free
global optimizer that maintains search history between iterations. It can handle bounds
and is robust to noisy objective functions.</p>

<p>Early stop threshold is implemented via callback mechanism.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>ds</strong>:  dataset</li>
<li><strong>model</strong>:  Model object</li>
<li><strong>revert_score_sign</strong>:  if the score is the bigger, the better; this algo minimizes score</li>
<li><strong>verbose</strong>:  print diagnostic or progress information</li>
<li><strong>epochs</strong>:  number of epochs; each epoch is independent and returns its own score and tuned params</li>
<li><strong>iters_epoch</strong>:  number of iterations per epoch</li>
<li><strong>error_score</strong>:  extremely bad value to be used as score if fit_predict returns None (error)</li>
<li><strong>cores</strong>:  processor cores to be used in parallel computing</li>
<li><strong>approach</strong>:  'void', 'init', 'sequent', 'init_sequent'</li>
<li><strong>save_epoch</strong>:  if every epoch to be saved or path to the folder to save tuned models</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>tuned Model of the last epoch</p>
</blockquote>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>